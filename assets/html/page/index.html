{{ template "head" . }}
<body>
{{ template "header" . }}
<div class="container-fluid">
    <div class="row">
    {{ template "api_dir" . }}
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" style="background-color: #ffffff;">
        
        <div class="box" style="margin-top: 8px;border: 1px solid #D3D3D3; border-radius: 4px;">
            <ul class="nav nav-tabs" id="docViewTable" style="width: 100%;height:54px;flex-direction: row;flex-wrap: nowrap;overflow-x: scroll;font-size: 11px;"></ul>
              <div id="doc" style="width: 100%; height: calc(100vh - 136px);background-color: #ffffff;overflow: auto;padding: 16px;position: relative;">
                <div class="row">
                    <div class="col-10">
                        <div id="notDocMain" style="display: none;">
                            <button type="button" class="btn btn-dark btn-lg" onclick="newAPIDoc('')">创建文档</button>
                        </div>
                      <div data-bs-spy="scroll" id="docMain" data-bs-target="#simple-list-example" data-bs-offset="0" data-bs-smooth-scroll="true" class="scrollspy-example" style="margin-top: .5rem;overflow: auto; padding-left: 22px;" tabindex="0">
                          {{ DocNav }}
                          <div class="mb52 mt16">
                            <h4 class="with-vertical-bar mb36" id="simple-list-item-1">基本信息</h4>
                            <div class="card">
                                <div class="card-body">
                                    <span id="docIdContent" style="display: none;"></span>
                                    <ul style="padding: 0;">
                                        {{ DocMainBaseInfo }}
                                        <li><span class="txt7">操作： </span><div class="btn-group btn-group-sm" role="group" aria-label="Basic outlined example" style="margin-left: 16px;">
                                            <button type="button" class="btn btn-outline-dark editDocButton" onclick="modifyDocContent()">{{ SVG "pencil-square" 16 16 }}</button>
                                            <button type="button" class="btn btn-outline-dark moveDocButton" onclick="moveDocIndex()">{{ SVG "arrows-move" 16 16 }}</button>
                                            <button type="button" class="btn btn-outline-dark shareButton" onclick="openDocShare()">{{ SVG "share-fill" 16 16 }}</button>
                                            <button type="button" class="btn btn-outline-dark recycleBinButton" onclick="moveToRecycleBin()">{{ SVG "file-earmark-minus" 16 16 }}</button>
                                            <button type="button" class="btn btn-outline-dark deleteButton" onclick="deleteDoc()">{{ SVG "file-x" 16 16 }}</button>
                                            <button type="button" class="btn btn-outline-dark">请求</button>
                                            <button type="button" class="btn btn-outline-dark">Mock</button>
                                            <a type="button" class="btn btn-outline-dark" href="https://www.zhaozhongtian.top" target="_blank">在线工具</a>
                                          </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                          </div>

                        <div class="mb52">
                            <h4 class="with-vertical-bar" id="simple-list-item-2" style="margin-bottom: 36px;">接口说明</h4>
                            <div class="card">
                                <div class="card-body" id="api-description"></div>
                            </div>
                        </div>

                        <div class="mb52">
                            <h4 class="with-vertical-bar mb36" id="simple-list-item-3">请求Header</h4>
                            <table class="table table-bordered table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col" class="docth" style="width: 20%;">字段</th>
                                        <th scope="col" class="docth" style="width: 5%;">类型</th>
                                        <th scope="col" class="docth" style="width: 5%;">必填</th>
                                        <th scope="col" class="docth" style="width: 20%;">描述</th>
                                        <th scope="col" class="docth" style="width: 20%;">示例</th>
                                    </tr>
                                </thead>
                                <tbody id="api-reqHeader"></tbody>
                            </table>
                        </div>

                        <div class="mb52">
                            <h4 class="with-vertical-bar mb36" id="simple-list-item-4">请求参数</h4>
                            <p>
                                <span class="txt7">请求数据类型: </span>
                                <span id="api-reqTypeStr">json</span>
                            </p>
                            <p class="txt7">示例:</p>
                            <div id="jsoneditorDiv" style="display: none;">
                                <button type="button" class="btn btn-dark closeReqZsText toolBtn" onclick="closeReqZsText()">关闭注释</button>
                                <button type="button" class="btn btn-dark openReqZsText toolBtn" style="display: none;" onclick="openReqZsText()">开启注释</button>
                                <button type="button" class="btn btn-dark toolBtn" onclick="copyReqJson()">复制</button>
                                <a type="button" class="btn btn-dark toolBtn" href="https://www.zhaozhongtian.top/code-json" target="_blank">在线json工具</a>
                                <div id="jsoneditor" style="width: 100%;margin-bottom: 16px;margin-top: 8px;"></div>
                            </div>
                            <div id="reqXmlDiv" class="card" style="display: none; margin-bottom: 24px;">
                                <div class="card-body">
                                </div>
                            </div>
                            <div id="reqTxtDiv" class="card" style="display: none; margin-bottom: 24px;">
                                <div class="card-body">
                                </div>
                            </div>
                            <p class="txt7">参数说明:</p>
                              <table class="table table-bordered table-hover table-striped" style="table-layout:fixed;display:table;">
                                  <thead>
                                  <tr>
                                      <th scope="col" class="docth" style="width: 20%;">字段</th>
                                      <th scope="col" class="docth" style="width: 5%;">类型</th>
                                      <th scope="col" class="docth" style="width: 5%;">必填</th>
                                      <th scope="col" class="docth" style="width: 20%;">描述</th>
                                      <th scope="col" class="docth" style="width: 20%;">示例</th>
                                  </tr>
                                  </thead>
                                  <tbody id="api-reqBodyInfo"></tbody>
                              </table>
                        </div>

                        <div class="mb52">
                            <h4 class="with-vertical-bar mb36" id="simple-list-item-5">响应</h4>
                            <p>
                                <span class="txt7">响应数据类型: </span>
                                <span id="api-respTypeStr">json</span>
                            </p>
                            <p class="txt7">示例:</p>
                            <div id="jsoneditorRespDiv" style="display: none;">
                                <button type="button" class="btn btn-dark closeRespZsText toolBtn" onclick="closeRespZsText()">关闭注释</button>
                                <button type="button" class="btn btn-dark openRespZsText toolBtn" style="display: none;" onclick="openRespZsText()">开启注释</button>
                                <button type="button" class="btn btn-dark toolBtn" onclick="copyRespJson()">复制</button>
                                <a type="button" class="btn btn-dark toolBtn" href="https://www.zhaozhongtian.top/code-json" target="_blank">在线json工具</a>
                                <div id="jsoneditorResp" style="width: 100%;margin-bottom: 16px;margin-top: 8px;"></div>
                            </div>
                            <div id="respTxtDiv" class="card" style="display: none; margin-bottom: 24px;">
                                <div class="card-body"></div>
                            </div>
                            <div id="respXmlDiv" class="card" style="display: none; margin-bottom: 24px;">
                                <div class="card-body"></div>
                            </div>
                            <p class="txt7">参数说明:</p>
                            <table class="table table-bordered table-hover table-striped" style="table-layout:fixed;display:table;">
                                <thead>
                                <tr>
                                    <th scope="col" class="docth" style="width: 20%;">字段</th>
                                    <th scope="col" class="docth" style="width: 5%;">类型</th>
                                    <th scope="col" class="docth" style="width: 20%;">描述</th>
                                    <th scope="col" class="docth" style="width: 20%;">示例</th>
                                </tr>
                                </thead>
                                <tbody id="api-respBodyInfo">
                                </tbody>
                            </table>
                        </div>

                        <div class="mb52">
                            <h4 class="with-vertical-bar" id="simple-list-item-7">请求代码</h4>
                            {{ RequestCode }}
                        </div>

                        <div class="mb52">
                            <h4 class="with-vertical-bar" id="simple-list-item-6">日志&镜像</h4>
                            <ul class="list-group list-group-flush" id="snapshot"></ul>
                        </div>
                      </div>
                    </div>
                    {{ DocMainPoint }}
                  </div>
              </div>
        </div>

        {{ ToastTemplate }}
        {{ template "ProjectModalAdd" . }}
        {{ template "ApiDocAddModal" . }}
        {{ template "DocAddDirModal" . }}
        {{ template "GlobalCodeModal" . }}
        {{ template "GlobalHeaderModal" . }}
        {{ template "ShareModal" . }}
        {{ template "DocMoveDirModal" . }}
        {{ template "DirSortModal" . }}
        {{ template "DocSortModal" . }}

    </main>

    </div>
</div>

</body>

{{ template "pubjs" . }}
<script>

    var editorAdd = {};
    var editorAddResp = {};

    var projectId = "{{ .projectId }}";
    var dirId = "";

    var editormdObj = editormd("test-editor", {
        markdown: "",
        height: 440,
        width: "100%",
        path: '/js/lib/',
        htmlDecode : "style,script,iframe|on*",
        imageUpload : true,
        imageFormats : ["jpg", "jpeg", "gif", "png", "bmp"],
        imageUploadURL : "url",
        saveHTMLToTextarea : true,
    });

    var reqType = "json";
    var respType = "json";

    var zs = {};
    var zsresp = [];

    const container = document.getElementById("jsoneditor");
    const options = {
        mode: 'view',
    };
    var editor = new JSONEditor(container, options);

    const containerResp = document.getElementById("jsoneditorResp");
    const optionsResp = {
        mode: 'view',
    };
    var editorResp = new JSONEditor(containerResp, optionsResp);

    const containerAdd = document.getElementById("jsoneditorAdd");
    const optionsAdd = {
        mode: 'code',
    };
    var editorAdd = new JSONEditor(containerAdd, optionsAdd);


    const containerAddResp = document.getElementById("jsoneditorAddResp");
    const optionsAddResp = {
        mode: 'code',
    };
    var editorAddResp = new JSONEditor(containerAddResp, optionsAddResp);

    $(document).on('click', '.dir-open', function() {
        var open = $(this).attr('data-open');
        var dirid = $(this).attr('data-dirid');
        $(this).find('span').empty();
        if (open === "0") {
            $(this).find('span').append('{{ SVG "folder2-open" 21 21 }}');
            $(this).attr('data-open', '1');
            $('#'+dirid).show();
            localStorage.setItem(dirOpenKey+dirid,1)
        } else {
            $(this).find('span').append('{{ SVG "folder" 21 21 }}');
            $(this).attr('data-open', '0');
            $('#'+dirid).hide();
            localStorage.setItem(dirOpenKey+dirid,0)
        }
    });

    $(document).on('hover', '.docli', function() {
        $(this).css('background-color', '#f6f6f6');
    });

    $(document).on('mouseenter', '.hover-area', function() {
        $(this).find('.action-btn').show();
        $(this).css({
            'height':'52px',
        })
    }).on('mouseleave', '.hover-area', function() {
        $(this).find('.action-btn').hide();
        $(this).css({
            'height':'52px',
        })
    });

    // $(document).on('mouseenter', '.dir', function() {
    //     tippyInit();
    //     $(this).find('.dirop').show();
    //     $(this).css({
    //         'height':'72px',
    //     })
    // }).on('mouseleave', '.dir', function() {
    //     $(this).find('.dirop').hide();
    //     $(this).css({
    //         'height':'42px',
    //     })
    // });

    function isShow(is) {
        var docMain=$("#docMain"), docMainML=$("#docMainML"), notDocMain=$("#notDocMain");
        if (is) {
            docMain.show();
            docMainML.show();
            notDocMain.hide();
        } else {
            docMain.hide();
            docMainML.hide();
            notDocMain.show();
        }
    }

    $(document).ready(function(){
        tippyInit();
        $('#newSort').click(function(){
            var ulValue = $( '#wrap' ).children();
            for (var i=0; i<ulValue.length; i++) {
                var liValue = ulValue[i].children;
                console.log(liValue);
                for(var j=0; j<liValue.length;j++) {
                    console.log(liValue[j]);
                }
            }
        });

        AjaxGet("/document/dir/list?pid="+projectId, function(data){
            if (data.code === 0 ) {
                var apiDir = data.data;
                for(var item in apiDir) {
                    if (apiDir.hasOwnProperty(item)){
                        var dirId = apiDir[item].dir.dirId;
                        var dirname = apiDir[item].dir.name;
                        var doc = apiDir[item].doc;
                        $("#wrap").append(dirDev(dirId, dirname));
                        $("#addDocDir").append(addDocDirOption(dirId, dirname));
                        for(var li in doc) {
                            if (doc.hasOwnProperty(li)) {
                                $("#"+dirId).append(docLi(doc[li].docId, doc[li].method, doc[li].title));
                            }
                        }
                    }
                }
                tippyInit();
            }
        });

        var viewDocList = viewDocGet(projectId);

        var param = {
            "pid": projectId,
            "docList": viewDocList,
        };

        if(localStorage.getItem(nowViewDoc+projectId) === "undefined" || localStorage.getItem(nowViewDoc+projectId)=== null) {
            isShow(false);
        }

        AjaxPost("/document/doc/list", param, function(data){
            if (data.code === 0 ) {
                for(var i=0; i<data.data.length; i++) {
                    if(data.data[i].docId === localStorage.getItem(nowViewDoc+projectId)) {
                        NowDoc(data.data[i].docId);
                    } else {
                        showViewDoc(data.data[i].method, data.data[i].name, data.data[i].docId, false);
                    }
                }
            }
        })

        $('#apiDocAddModal').on('shown.bs.modal', function () {
            console.log("apiDocAddModal shown.bs.modal")
            editormdObj = editormd("test-editor", {
                markdown: "",
                height: 440,
                width: "100%",
                path: '/js/lib/',
                htmlDecode : "style,script,iframe|on*",
                imageUpload : true,
                imageFormats : ["jpg", "jpeg", "gif", "png", "bmp"],
                imageUploadURL : "url",
                saveHTMLToTextarea : true,
            });

        });

    });

    function openBodyMain(type) {
        var bodyJson = $("#bodyJson");
        var bodyFromData = $("#bodyFromData");
        var bodyXwwwFrom = $("#bodyXwwwFrom");
        var bodyXml = $("#bodyXml");
        var bodyText = $("#bodyText");
        var bodyGo = $("#bodyGo");
        var bodyTs = $("#bodyTs");

        var openBodyBtnJson = $("#openBodyBtn-json");
        var openBodyBtnFromData = $("#openBodyBtn-from-data");
        var openBodyBtnXWwwFormUrlencoded = $("#openBodyBtn-x-www-form-urlencoded");
        var openBodyBtnXml = $("#openBodyBtn-xml");
        var openBodyBtnPlain = $("#openBodyBtn-plain");
        var openBodyBtnGo = $("#openBodyBtn-go");
        var openBodyBtnTs = $("#openBodyBtn-ts");

        bodyJson.hide();
        bodyFromData.hide();
        bodyXwwwFrom.hide();
        bodyXml.hide();
        bodyText.hide();
        bodyGo.hide();
        bodyTs.hide();

        openBodyBtnJson.removeClass('btn-light');
        if (!openBodyBtnJson.hasClass('btn-dark')) {
            openBodyBtnJson.addClass('btn-dark');
        }

        openBodyBtnFromData.removeClass('btn-light');
        if (!openBodyBtnFromData.hasClass('btn-dark')) {
            openBodyBtnFromData.addClass('btn-dark');
        }

        openBodyBtnXWwwFormUrlencoded.removeClass('btn-light');
        if (!openBodyBtnXWwwFormUrlencoded.hasClass('btn-dark')) {
            openBodyBtnXWwwFormUrlencoded.addClass('btn-dark');
        }

        openBodyBtnXml.removeClass('btn-light');
        if (!openBodyBtnXml.hasClass('btn-dark')) {
            openBodyBtnXml.addClass('btn-dark');
        }

        openBodyBtnPlain.removeClass('btn-light');
        if (!openBodyBtnPlain.hasClass('btn-dark')) {
            openBodyBtnPlain.addClass('btn-dark');
        }

        openBodyBtnGo.removeClass('btn-light');
        if (!openBodyBtnGo.hasClass('btn-dark')) {
            openBodyBtnGo.addClass('btn-dark');
        }

        openBodyBtnTs.removeClass('btn-light');
        if (!openBodyBtnTs.hasClass('btn-dark')) {
            openBodyBtnTs.addClass('btn-dark');
        }

        switch (type) {
            case 'json':
                bodyJson.show();
                openBodyBtnJson.removeClass('btn-dark');
                openBodyBtnJson.addClass('btn-light');
                reqType = "json";
                break
            case 'from-data':
                bodyFromData.show();
                openBodyBtnFromData.removeClass('btn-dark');
                openBodyBtnFromData.addClass('btn-light');
                reqType = "from-data";
                break
            case 'x-www-form-urlencoded':
                bodyXwwwFrom.show();
                openBodyBtnXWwwFormUrlencoded.removeClass('btn-dark');
                openBodyBtnXWwwFormUrlencoded.addClass('btn-light');
                reqType = "x-www-form-urlencoded";
                break
            case 'xml':
                bodyXml.show();
                openBodyBtnXml.removeClass('btn-dark');
                openBodyBtnXml.addClass('btn-light');
                reqType = "xml";
                break
            case 'plain':
                bodyText.show();
                openBodyBtnPlain.removeClass('btn-dark');
                openBodyBtnPlain.addClass('btn-light');
                reqType = "text";
                break
            case 'go':
                bodyGo.show();
                openBodyBtnGo.removeClass('btn-dark');
                openBodyBtnGo.addClass('btn-light');
                reqType = "json";
                break
            case 'ts':
                bodyTs.show();
                openBodyBtnTs.removeClass('btn-dark');
                openBodyBtnTs.addClass('btn-light');
                reqType = "json";
                break
        }
    }

    function openRespMain(type) {
        var respJson = $("#respJson");
        var respXml = $("#respXml");
        var respText = $("#respText");
        var respGo = $("#respGo");
        var respTs = $("#respTs");

        var openRespBtnJson = $("#openRespBtn-json");
        var openRespBtnXml = $("#openRespBtn-xml");
        var openRespBtnPlain = $("#openRespBtn-plain");
        var openRespBtnGo = $("#openRespBtn-go");
        var openRespBtnTs = $("#openRespBtn-ts");

        respJson.hide();
        respXml.hide();
        respText.hide();
        respGo.hide();
        respTs.hide();

        openRespBtnJson.removeClass('btn-light');
        if (!openRespBtnJson.hasClass('btn-dark')) {
            openRespBtnJson.addClass('btn-dark');
        }

        openRespBtnXml.removeClass('btn-light');
        if (!openRespBtnXml.hasClass('btn-dark')) {
            openRespBtnXml.addClass('btn-dark');
        }

        openRespBtnPlain.removeClass('btn-light');
        if (!openRespBtnPlain.hasClass('btn-dark')) {
            openRespBtnPlain.addClass('btn-dark');
        }

        openRespBtnGo.removeClass('btn-light');
        if (!openRespBtnGo.hasClass('btn-dark')) {
            openRespBtnGo.addClass('btn-dark');
        }

        openRespBtnTs.removeClass('btn-light');
        if (!openRespBtnTs.hasClass('btn-dark')) {
            openRespBtnTs.addClass('btn-dark');
        }

        switch (type) {
            case 'json':
                respJson.show();
                openRespBtnJson.removeClass('btn-dark');
                openRespBtnJson.addClass('btn-light');
                respType = "json";
                break
            case 'xml':
                respXml.show();
                openRespBtnXml.removeClass('btn-dark');
                openRespBtnXml.addClass('btn-light');
                respType = "xml";
                break
            case 'plain':
                respText.show();
                openRespBtnPlain.removeClass('btn-dark');
                openRespBtnPlain.addClass('btn-light');
                respType = "text";
                break
            case 'go':
                respGo.show();
                openRespBtnGo.removeClass('btn-dark');
                openRespBtnGo.addClass('btn-light');
                respType = "json";
                break
            case 'ts':
                respTs.show();
                openRespBtnTs.removeClass('btn-dark');
                openRespBtnTs.addClass('btn-light');
                respType = "json";
                break
        }
    }

    $(document).on('click', '.headerRemove', function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#setHeaderTable tr:eq('+index+')').remove();
    });

    function saveAddDoc(submitType) {

        if($("#addDocName").val() === "") {
            ToastShow("文档名不能为空!");
            return
        }

        if($("#addDocUrl").val() === "") {
            ToastShow("接口Url不能为空!");
            return
        }

        var reqHeader = [];
        var reqBodyInfo = [];
        var respInfo = [];

        var headerField = $('.addDocHeaderField').map(function() {
            return $(this).val();
        }).get();
        var headerIsRequired = $('.addDocHeaderIsRequired').map(function() {
            return $(this).val();
        }).get();
        var headerVarType = $('.addDocHeaderVarType').map(function() {
            return $(this).val();
        }).get();
        var headerDescription = $('.addDocHeaderDescription').map(function() {
            return $(this).val();
        }).get();
        var headerExample = $('.addDocHeaderExample').map(function() {
            return $(this).val();
        }).get();
        for (var i=0; i<headerField.length; i++) {
            reqHeader.push({
                "field":  headerField[i],     // 字段
                "varType":  headerVarType[i],   // 类型
                "description": headerDescription[i], // 描述
                "example": headerExample[i],    // 示例
                "isRequired":  Number(headerIsRequired[i]), // 是否必填 1:必填
                "sort": i,        // 排序
            })
        }

        var reqField = $('.reqField').map(function() {
            return $(this).val();
        }).get();

        var reqDescription = $('.reqDescription').map(function() {
            return $(this).val();
        }).get();

        var reqVarType = $('.reqVarType').map(function() {
            return $(this).val();
        }).get();

        var reqExample = $('.reqExample').map(function() {
            return $(this).val();
        }).get();

        var reqIsRequired = $('.reqIsRequired').map(function() {
            return $(this).val();
        }).get();

        for (var i=0; i<reqField.length; i++) {
            reqBodyInfo.push({
                "field": reqField[i],
                "varType":  reqVarType[i],    // 类型
                "description": reqDescription[i], // 描述
                "example":  reqExample[i],   // 示例
                "isRequired":  Number(reqIsRequired[i]), // 是否必填 1:必填
                "sort": i,        // 排序
            })
        }

        var respField = $('.respField').map(function() {
            return $(this).val();
        }).get();

        var respDescription = $('.respDescription').map(function() {
            return $(this).val();
        }).get();

        var respVarType = $('.respVarType').map(function() {
            return $(this).val();
        }).get();

        var respExample = $('.respExample').map(function() {
            return $(this).val();
        }).get();

        for (var i=0; i<respField.length; i++) {
            respInfo.push({
                "field":  respField[i],   // 字段
                "varType":   respVarType[i],  // 类型
                "description":  respDescription[i], // 描述
                "example":     respExample[i],  // 示例
                "sort": i,       // 排序
            })
        }

        var respBody = ""
        if (respType === "json") {
            respBody = JSON.stringify(editorAddResp.get())
        }
        if (respType === "xml") {
            respBody = $("#respXml textarea").val()
        }
        if (respType === "text") {
            respBody = $("#respText textarea").val()
        }

        console.log("respBody -> "+ respBody)

        var docId = "";
        if(submitType === 2) {
            docId = localStorage.getItem(nowViewDoc+projectId)
        }

        var param = {
            "projectId": projectId,
            "dirId": $("#addDocDir").val(),
            "content": {
                "docId": docId,
                "projectId": projectId,
                "name": $("#addDocName").val(),
                "url": $("#addDocUrl").val(),
                "method": $("#addDocMethod").val(),
                "description": editormdObj.getMarkdown(),
                "descriptionHtml": editormdObj.getPreviewedHTML(),
                "reqHeader": reqHeader,      // 请求头 []*ReqHeaderItem
                "reqType": reqType,                  // 请求类型
                "reqBodyJson": JSON.stringify(editorAdd.get()),              // 请求参数 - json
                "reqBodyText": $("#bodyText textarea").val(),               // 请求参数 - text
                "reqBodyXml": $("#bodyXml textarea").val(),     // 请求参数 - xml
                "reqBodyInfo": reqBodyInfo,              // 请求参数说明   []*BodyInfoItem
                "respType": respType,
                "resp": [{
                    "tag": "成功",      // 默认 成功
                    "respType": respType, // 响应类型
                    "respBody" : respBody,                // 请求响应 - json
                    "respBodyInfo": respInfo,      // 请求响应 - 数据
                }],
            }
        }

        if(submitType === 2) {
            AjaxPost("/document/modify", param, function (data){
                ToastShow(data.msg);
                if (data.code === 0) {
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                }
            });
        }else {
            AjaxPost("/document/create", param, function (data){
                ToastShow(data.msg);
                if (data.code === 0) {
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                }
            });
        }
    }

    $(document).on('click', '.addReq', function() {
        $("#setReqTable").append(addReqTpl("", "", "", "", "1"));
    });

    $(document).on('click', '.removeReq', function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#setReqTable tr:eq('+index+')').remove();
    });

    function jsonToRespInfoItem(jsonObj, parentKey) {
        var jsonInfo = jsonObj

        for (var key in jsonInfo) {

            var reqField = $('.respField').map(function() {
                return $(this).val();
            }).get();

            var reqVarType = $('.respVarType').map(function() {
                return $(this).val();
            }).get();

            var reqExample =  $('.respExample').map(function() {
                return $(this).val();
            }).get();

            var keyType = typeof jsonInfo[key]
            if (keyType === "object") {
                keyType = isArrayOrObject(jsonInfo[key])
            }
            if (keyType === "string" && jsonInfo[key].length > 188) {
                jsonInfo[key] = jsonInfo[key].substring(0,188)+"..."
            }
            var flag = false
            for (var has in reqField) {
                if (reqField[has] === key) {
                    if (reqVarType[has] !== keyType) {
                        $('.respVarType:eq('+has+')').val(keyType);
                    }
                    if (reqExample[has] !== jsonInfo[key]) {
                        $('.respExample:eq('+has+')').val(jsonInfo[key]);
                    }
                    flag = true
                }
            }

            var field = key
            if (parentKey !== "") {
                field = parentKey+"."+key
            }

            if (!flag && reqField[0] === "") {
                $(".respField").first().val(field);
                $(".respVarType").first().val(keyType);
                $(".respExample").first().val(jsonInfo[key]);
            } else if (!flag) {
                $("#setRespTable").append(addRespTpl(field, keyType, jsonInfo[key], ""));
            }

            if (keyType === "object") {
                var newParentKey = parentKey
                if (newParentKey === "") {
                    newParentKey = key
                }else {
                    newParentKey = parentKey+ "."+key
                }
                jsonToRespInfoItem(jsonInfo[key], newParentKey)
            }

            if (keyType === "array") {
                if (isArrayOrObject(jsonInfo[key][0]) === "object") {
                    var newParentKey = parentKey
                    if (newParentKey === "") {
                        newParentKey = key
                    } else {
                        newParentKey = parentKey+ "."+key
                    }
                    jsonToRespInfoItem(jsonInfo[key][0], newParentKey)
                }
            }
        }
    }

    function jsonToRespInfo() {
        var jsonInfo = editorAddResp.get();
        jsonToRespInfoItem(jsonInfo, "")
    }

    function showViewDoc(apiMethod, apiName, docId, isActive) {
        var docViewItem = $('.docViewItem').map(function() {
            return $(this).attr("data-docid");
        }).get();

        for (var i=0; i<docViewItem.length; i++) {
            if (docViewItem[i] === docId) {
                var docViewTable =  $("#docViewTable")
                docViewTable.find('a').each(function() {
                    $(this).removeClass("active")
                });
                $(".docViewItem[data-docid="+docId+"]").addClass("active")
                var x = ($(".docViewItem[data-docid="+docId+"]").offset().left-docViewTable.width())+400
                docViewTable.animate({
                    scrollLeft: x,
                }, 500);
                return
            }
        }

        var isActiveStr = ""
        if (isActive) {
            var docViewTable =  $("#docViewTable")
            docViewTable.find('a').each(function() {
                $(this).removeClass("active")
            });
            isActiveStr = "active"
        }
        $("#docViewTable").append(docViewItemTpl(isActiveStr, docId, apiMethod, apiName));
        $('#docViewTable').scrollLeft(9999);
    }

    $(document).on('click', '.addResp', function (){
        $("#setRespTable").append(addRespTpl("", "", "", ""));
    });

    $(document).on('click', '.removeResp', function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#setRespTable tr:eq('+index+')').remove();
    })

    function NowDoc(docId) {
        var param = {
            "pid": projectId,
            "docId": docId,
        }
        AjaxPostNotAsync("/document/item", param, function(data){
            if (data.code === 0 ) {
                localStorage.setItem(nowViewDoc+projectId, docId)
                showViewDoc(data.data.content.method, data.data.content.name, docId, true)
                loadApiDoc(data.data.content, data.data.snapshotList)
                loadReqCode(data.data.reqCode)
            }
        })
    }

    $(document).on('click', '.docli', function(event) {
        var docId = $(this).prop('id');
        isShow(true)
        viewDocAdd(projectId, docId)
        NowDoc(docId)
    })

    $(document).on('click', '.docViewItem', function (event){
        var docViewTable =  $("#docViewTable")
        docViewTable.find('a').each(function() {
            $(this).removeClass("active")
        });
        $(this).addClass("active")
        var x = ($(this).offset().left-docViewTable.width())+400
        docViewTable.animate({
            scrollLeft: x,
        }, 500);
        var docId = $(this).attr("data-docid")
        localStorage.setItem(nowViewDoc+projectId, docId)
        NowDoc(docId)
    })

    $(document).on('click', '.docViewClose', function (event){
        event.stopPropagation();
        var target = event.target;
        var index = $(target).parents("li").index();
        var now = $('#docViewTable li:eq('+index+')')

        if(now.find("a").hasClass("active")) {
            if (index>0) {
                var i = index-1
                $('#docViewTable li:eq('+i+')').find("a").addClass("active")
                var docId = $('#docViewTable li:eq('+i+')').find("a").attr("data-docid")
                localStorage.setItem(nowViewDoc+projectId, docId)
                NowDoc(docId)
            }else {
                var i = index+1
                $('#docViewTable li:eq('+i+')').find("a").addClass("active")
                var docId = $('#docViewTable li:eq('+i+')').find("a").attr("data-docid")
                localStorage.setItem(nowViewDoc+projectId, docId)
                NowDoc(docId)
            }
        }
        now.remove();

        var docId = now.find("a").attr("data-docid")

        viewDocDel(projectId, docId)

        if(localStorage.getItem(nowViewDoc+projectId) === "undefined") {
            isShow(false)
        }
    })

    function openAddDocDir() {
        $('#docAddDirModal').modal('show');
    }

    function addDocDir() {
        const url = "/document/dir/create"
        var param = {
            "pid": projectId,
            "dirName": $("#docAddDirName").val()
        }
        AjaxPost(url, param, function (data){
            ToastShow(data.msg);
            if (data.code === 0) {
                setTimeout(function() {
                    location.reload();
                }, 1000);
            }
        })
    }

    function closeReqZsText() {
        $(".zsReqText").remove();
        $(".closeReqZsText").hide();
        $(".openReqZsText").show();
    }

    function closeRespZsText() {
        $(".zsRespText").remove();
        $(".closeRespZsText").hide();
        $(".openRespZsText").show();
    }

    function openReqZsText() {
        $("#jsoneditor").find(".jsoneditor-field").each(function() {
            var id = $(this).prop("id")
            var regex = new RegExp("0,", "g");
            id = id.replace(regex, "");
            if (zs[id]){
                $(this).parent().parent().append('<td class="zsReqText zsText"> /* '+zs[id]+' */</td>')
            }
        })
        $(".closeReqZsText").show();
        $(".openReqZsText").hide();
    }

    function openRespZsText() {
        $("#jsoneditorResp").find(".jsoneditor-field").each(function() {
            var id = $(this).prop("id")
            var regex = new RegExp("0,", "g");
            id = id.replace(regex, "");
            if (zsresp[id]){
                $(this).parent().parent().append('<td class="zsRespText zsText"> /* '+zsresp[id]+' */</td>')
            }
        })
        $(".closeRespZsText").show();
        $(".openRespZsText").hide();
    }

    function copyReqJson() {
        var jsonObj =  editor.get()
        copyContent(JSON.stringify(jsonObj))
    }

    function copyRespJson() {
        var jsonObj =  editorResp.get()
        copyContent(JSON.stringify(jsonObj))
    }

    function goToRespInfo() {
        var param = {
            "text": $("#respGo textarea").val(),
        }
        AjaxPost("/tool/goStructToField", param, function (data){

            delRespTpl();

            for(var i=0; i<data.data.length; i++) {

                var respField = $('.respField').map(function() {
                    return $(this).val();
                }).get();

                if (respField[0] === "") {
                    $(".respField").first().val(data.data[i].field);
                    $(".respVarType").first().val(data.data[i].varType);
                    $(".respDescription").first().val(data.data[i].description);
                } else {
                    $("#setRespTable").append(addRespTpl(data.data[i].field, data.data[i].varType, "", data.data[i].description));
                }
            }

        })

    }

    function goToReqInfo() {
        var param = {
            "text": $("#bodyGo textarea").val(),
        }
        AjaxPost("/tool/goStructToField", param, function (data){

            delReqTpl();

            for(var i=0; i<data.data.length; i++) {

                var reqField = $('.reqField').map(function() {
                    return $(this).val();
                }).get();

                if (reqField[0] === "") {
                    $(".reqField").first().val(data.data[i].field);
                    $(".reqVarType").first().val(data.data[i].varType);
                    $(".reqDescription").first().val(data.data[i].description);
                } else {
                    $("#setReqTable").append(addReqTpl(data.data[i].field, data.data[i].varType, "", data.data[i].description, "1"));
                }
            }

        })
    }

    function clearDocEditor(opType) {

        $("#apiDocAddModalLabel").empty();
        if(opType === 2) {
            $("#apiDocAddModalLabel").append("编辑接口文档");
            $("#saveAdd").hide();
            $("#saveModify").show();
        } else {
            $("#apiDocAddModalLabel").append("新建接口文档");
            $("#saveAdd").show();
            $("#saveModify").hide();
        }

        var addDocName = $("#addDocName");
        var addDocUrl = $("#addDocUrl");
        var addDocMethod = $("#addDocMethod");
        var addDocDir = $("#addDocDir");
        var setHeaderTable = $("#setHeaderTable");
        var setReqTable = $("#setReqTable");
        var setRespTable = $("#setRespTable");

        addDocName.val("");
        addDocUrl.val("");

        var addDocMethodOption = $('#addDocMethod option').map(function(){
            return $(this).val();
        }).get();
        if (addDocMethodOption.length > 0 ) {
            addDocMethod.val(addDocMethodOption[0]);
        }

        var addDocDirOption = $('#addDocDir option').map(function(){
            return $(this).val();
        }).get();
        if (addDocDirOption.length > 0 ) {
            addDocDir.val(addDocDirOption[0]);
        }

        setHeaderTable.empty()
        setHeaderTable.append(initHeaderAdd())

        editorAdd.set({})

        $("#bodyXml textarea").val()
        $("#bodyText textarea").val()

        setReqTable.empty()
        setReqTable.append(initAddReqTpl())

        editorAddResp.set({})

        $("#respXml textarea").val()
        $("#respText textarea").val()

        setRespTable.empty()
        setRespTable.append(initAddRespTpl())

        editormdObj.clear();

    }

    function modifyDoc(docId) {

        var param = {
            "pid": projectId,
            "docId": docId,
        }
        AjaxPostNotAsync("/document/item", param, function(data){
            if (data.code === 0 ) {
                clearDocEditor(2)

                var addDocName = $("#addDocName");
                var addDocUrl = $("#addDocUrl");
                var addDocMethod = $("#addDocMethod");
                var addDocDir = $("#addDocDir");
                var addDocHeaderField = $('.addDocHeaderField');
                var addDocHeaderIsRequired = $('.addDocHeaderIsRequired');
                var addDocHeaderVarType = $('.addDocHeaderVarType');
                var addDocHeaderDescription = $('.addDocHeaderDescription');
                var addDocHeaderExample = $('.addDocHeaderExample');
                var reqField = $('.reqField');
                var reqDescription = $('.reqDescription');
                var reqVarType = $('.reqVarType');
                var reqExample = $('.reqExample');
                var reqIsRequired = $('.reqIsRequired');
                var respField = $('.respField');
                var respDescription = $('.respDescription');
                var respVarType = $('.respVarType');
                var respExample = $('.respExample');

                addDocName.val(data.data.content.name);
                addDocUrl.val(data.data.content.url);
                addDocMethod.val(data.data.content.method);
                addDocDir.val(data.data.baseInfo.dirId);

                editormdObj.appendMarkdown(data.data.content.description);

                var reqHeader = data.data.content.reqHeader;
                for( var i=0; i<reqHeader.length; i++ ){
                    if (i===0) {
                        addDocHeaderField.first().val(reqHeader[0].field);
                        addDocHeaderIsRequired.first().val(reqHeader[0].isRequired);
                        addDocHeaderVarType.first().val(reqHeader[0].varType);
                        addDocHeaderDescription.first().val(reqHeader[0].description);
                        addDocHeaderExample.first().val(reqHeader[0].example);
                    } else {
                        $("#setHeaderTable").append(headerAddTpl(reqHeader[i].field, reqHeader[i].isRequired, reqHeader[i].varType,
                            reqHeader[0].description, reqHeader[0].example))
                    }
                }

                switch (data.data.content.reqType) {
                    case "json":
                        editorAdd.set(JSON.parse(data.data.content.reqBodyJson))
                        break
                    case "xml":
                        $("#bodyXml textarea").val(data.data.content.reqBodyXml)
                        break
                    case "plain":
                        $("#bodyText textarea").val(data.data.content.reqBodyText)
                }

                var reqBodyInfo = data.data.content.reqBodyInfo;
                for (var i=0; i<reqBodyInfo.length; i++) {
                    if (i===0) {
                        reqField.first().val(reqBodyInfo[0].field);
                        reqDescription.first().val(reqBodyInfo[0].description);
                        reqVarType.first().val(reqBodyInfo[0].varType);
                        reqExample.first().val(reqBodyInfo[0].example);
                        reqIsRequired.first().val(reqBodyInfo[0].isRequired);
                    } else {
                        $("#setReqTable").append(addReqTpl(reqBodyInfo[i].field, reqBodyInfo[i].varType, reqBodyInfo[i].example,
                            reqBodyInfo[i].description, reqBodyInfo[i].isRequired));
                    }
                }

                var respList = data.data.content.resp;
                if (respList.length > 0 ) {
                    var resp =  respList[0]
                    switch (resp.reqType) {
                        case "json":
                            editorAddResp.set(JSON.parse(resp.respBody));
                            break
                        case "xml":
                            $("#respXml textarea").val(resp.respBody);
                            break
                        case "plain":
                            $("#respText textarea").val(resp.respBody);
                            break
                    }

                    var respBody = resp.respBodyInfo;
                    for (var i=0; i<respBody.length; i++) {
                        if (i===0) {
                            respField.first().val(respBody[0].field);
                            respDescription.first().val(respBody[0].description);
                            respVarType.first().val(respBody[0].varType);
                            respExample.first().val(respBody[0].example);
                        }else {
                            $("#setRespTable").append(addRespTpl(respBody[i].field, respBody[i].varType, respBody[i].example,
                                respBody[i].description))
                        }
                    }
                }

                $('#apiDocAddModal').modal('show');
            }
        })

    }

    function modifyDocContent() {
        var docId = $("#docIdContent").text();
        console.log(docId)
        modifyDoc(docId)
    }

    $(document).on('click', '.editDocButton', function (event){
        event.stopPropagation();
        var docId = $(this).parents("li").attr("id");
        modifyDoc(docId)
    })

    function openSnapshot(snapshotDocId, snapshotId) {
        var param = {
            "docId": snapshotDocId,
            "snapshotId": snapshotId,
        }
        AjaxPostNotAsync("/document/snapshot/item", param, function(data){
            if (data.code === 0 ) {
                $("#docNavSnapshot").empty();
                $("#docNavSnapshot").append("镜像:"+data.data.item.snapshotId);
                $("#docNav").show();
                loadApiDoc(data.data.item.documentContent, data.data.snapshotList);
                loadReqCode(data.data.reqCode)
                $("#docMain").animate({scrollTop:0}, 500);
            }
        })
    }

    function openGlobalCodeModal() {
        AjaxGetNotAsync("/project/code/list?pid="+projectId, function (data){
            console.log(data)
            if (data.code === 0) {
                var globalCodeTable = $("#globalCodeTable");
                globalCodeTable.empty();
                globalCodeTable.append(initGlobalCodeTpl());

                for(var i=0; i<data.data.length; i++) {
                    if (i===0) {
                        $(".globalCodeKey").first().val(data.data[0].field);
                        $(".globalCodeDescription").first().val(data.data[0].description);
                    } else {
                        globalCodeTable.append(addGlobalCodeTpl(data.data[i].field, data.data[i].description));
                    }
                }

                $('#globalCodeModal').modal('show');
            }else {
                ToastShow(data.msg);
            }
        });
    }

    function openGlobalHeaderModal() {
        AjaxGetNotAsync("/project/header/list?pid="+projectId, function (data){
            if (data.code === 0) {
                var globalHeaderTable = $("#globalHeaderTable")
                globalHeaderTable.empty();
                globalHeaderTable.append(initGlobalHeaderAddTpl());

                for(var i=0; i<data.data.length; i++) {
                    if (i===0) {
                        $(".globalHeaderIsRequired").first().val(data.data[0].isRequired);
                        $(".globalHeaderField").first().val(data.data[0].field);
                        $(".globalHeaderDescription").first().val(data.data[0].description);
                        $(".globalHeaderVarType").first().val(data.data[0].varType);
                        $(".globalHeaderExample").first().val(data.data[0].example);
                    } else {
                        globalHeaderTable.append(addGlobalHeaderAddTpl(data.data[i].isRequired, data.data[i].field, data.data[i].description,
                            data.data[i].varType, data.data[i].example));
                    }
                }

                $('#globalHeaderModal').modal('show');
            } else {
                ToastShow(data.msg);
            }
        })

    }

    $(document).on('click', '.globalCodeAdd', function (){
        $("#globalCodeTable").append(addGlobalCodeTpl("", ""))
    });

    $(document).on('click', '.globalCodeRemove', function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#globalCodeTable tr:eq('+index+')').remove();
    })

    $(document).on('click', '.globalHeaderAdd', function (){
        $("#globalHeaderTable").append(addGlobalHeaderAddTpl("", "", "", "", ""))
    });

    $(document).on('click', '.globalHeaderRemove',  function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#globalHeaderTable tr:eq('+index+')').remove();
    })

    function globalCodeSubmit() {
        var globalCodeKey = $('.globalCodeKey').map(function() {
            return $(this).val();
        }).get();
        var globalCodeDescription = $('.globalCodeDescription').map(function() {
            return $(this).val();
        }).get();

        var list = []

        for (var i=0; i<globalCodeKey.length; i++) {
            list.push({
                "field":  globalCodeKey[i],     // 字段
                "description": globalCodeDescription[i], // 描述
            })
        }

        var param = {
            "projectId": projectId,
            "list": list,
        }

        AjaxPost("/project/code/add", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0 ) {
                $('#globalCodeModal').modal('hide');
            }
        });
    }

    function globalHeaderSubmit() {
        var globalHeaderIsRequired = $('.globalHeaderIsRequired').map(function() {
            return $(this).val();
        }).get();
        var globalHeaderField = $('.globalHeaderField').map(function() {
            return $(this).val();
        }).get();
        var globalHeaderDescription = $('.globalHeaderDescription').map(function() {
            return $(this).val();
        }).get();
        var globalHeaderVarType = $('.globalHeaderVarType').map(function() {
            return $(this).val();
        }).get();
        var globalHeaderExample = $('.globalHeaderExample').map(function() {
            return $(this).val();
        }).get();

        var list = []

        for (var i=0; i<globalHeaderField.length; i++) {
            list.push({
                "field" : globalHeaderField[i],
                "varType" : globalHeaderVarType[i],
                "description" : globalHeaderDescription[i],
                "example" : globalHeaderExample[i],
                "isRequired" : Number(globalHeaderIsRequired[i]),
            })
        }

        var param = {
            "projectId" : projectId,
            "reqHeader" : list,
        }

        AjaxPost("/project/header/add", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0 ) {
                $('#globalHeaderModal').modal('hide');
            }
        });
    }

    $(document).on('click', '.docShare', function (event){
        event.stopPropagation();
        var docId = $(this).data("docid");
        openShare(2, docId)
    });

    function moveDocIndex() {
        var docId = localStorage.getItem(nowViewDoc+projectId) ;
        $("#moveDocId").val(docId);
        AjaxPost("/document/dir/all?pid="+projectId, "",function (data){
            $("#dirList").empty();
            for(var i=0; i<data.data.length; i++) {
                $("#dirList").append('<option value="'+data.data[i].dirId+'">'+data.data[i].dirName+'</option>');
            }
            $("#docMoveDirModal").modal('show');
        });
    }

    function moveToRecycleBin() {
        var docId = localStorage.getItem(nowViewDoc+projectId) ;
        var param = {
            "pid": projectId,
            "docId": docId,
        }
        AjaxPost("/document/move/toRecycleBin", param,function (data){
            ToastShow(data.msg);
            localStorage.setItem(data.data,1)
            if (data.code === 0 ) {
                location.reload();
            }
        });
    }

    function deleteDoc() {
        var docId = localStorage.getItem(nowViewDoc+projectId) ;
        var param = {
            "pid": projectId,
            "docId": docId,
        }
        AjaxPost("/document/delete", param,function (data){
            ToastShow(data.msg);
            if (data.code === 0 ) {

                $('#docViewTable li:eq(0)').find("a").addClass("active")
                var docId = $('#docViewTable li:eq(0)').find("a").attr("data-docid")
                localStorage.setItem(nowViewDoc+projectId, docId)
                NowDoc(docId)

                location.reload();

            }
        });
    }

    $(document).on('click', '.moveDoc', function (event){
        event.stopPropagation();
        var docId = $(this).data("docid");
        $("#moveDocId").val(docId);
        AjaxPost("/document/dir/all?pid="+projectId, "",function (data){
            $("#dirList").empty();
            for(var i=0; i<data.data.length; i++) {
                $("#dirList").append('<option value="'+data.data[i].dirId+'">'+data.data[i].dirName+'</option>');
            }
            $("#docMoveDirModal").modal('show');
        });
    });

    function moveDoc() {
        var docId = $("#moveDocId").val();
        var newDir = $("#dirList").val();
        var param = {
            "pid": projectId,
            "dirIdNew": newDir,
            "docId": docId,
        }
        AjaxPost("/document/changeDir", param,function (data){
            ToastShow(data.msg);
            localStorage.setItem(dirOpenKey+newDir,1)
            if (data.code === 0 ) {
                $('#docMoveDirModal').modal('hide');
                location.reload();
            }
        });
    }

    function openDocShare() {
        console.log("openDocShare")
        var docId = localStorage.getItem(nowViewDoc+projectId)
        console.log(docId)
        if(docId !== "undefined") {
            openShare(2, docId)
        }
    }

    function openShare(sType, docId) {
        var shareModalLabel = $("#shareModalLabel")
        shareModalLabel.empty()

        var projectShareBtn = $("#projectShareBtn")
        var docShareBtn = $("#docShareBtn")

        projectShareBtn.hide()
        docShareBtn.hide()

        switch (sType) {
            case 1:
                shareModalLabel.append("分享项目")
                projectShareBtn.show()
                break
            case 2:
                shareModalLabel.append("分享文档")
                $("#shareDocId").val(docId)
                docShareBtn.show()
                break
        }

        shareListLoad(sType, docId)

        $('#shareModal').modal('show');
    }

    function shareListLoad(sType, docId) {
        switch (sType) {
            case 1:
                AjaxGetNotAsync("/share/info/project?pid="+projectId, function (data) {
                    console.log(data)
                    if (data.code === 0) {
                        shareListShow(data.data)
                    }
                })
                break
            case 2:
                AjaxGetNotAsync("/share/info/document?docId="+docId, function (data) {
                    console.log(data)
                    if (data.code === 0) {
                        shareListShow(data.data)
                    }
                })
                break
        }
    }

    function shareListShow(data) {
        var shareList = $('#shareList')
        shareList.empty()
        const currentHost = window.location.host + "/browse/";
        for (var i=0; i<data.length; i++ ) {

            var expiration = ""
            if (data[i].expiration === 0 ) {
                expiration = "过期"
            }else if (data[i].expiration === -1 ) {
                expiration = "永久"
            }else {
                expiration = data[i].expiration+"天"
            }

            var password = ""
            if (data[i].isPassword === 1) {
                password = '<span class="badge text-bg-info">密码: '+data[i].passwordCode+'</span>'
            }else {
                password =  '<span class="badge text-bg-info">公开</span>'
            }

            shareList.append('<div class="list-group-item list-group-item-action">\n' +
                '                        <span style="margin-right: 16px;">'+currentHost+data[i].key+'</span> '+
                '<span class="badge text-bg-dark" style="margin-right: 8px;">'+expiration+'</span>'+ password +
                '                        <button type="button" class="btn btn-link" style="float: right;" onclick="cpShare(\''+currentHost+data[i].key+'\')">复制</button>\n' +
                '                        <button type="button" class="btn btn-link" style="float: right; color: red" onclick="delShare(\''+data[i].key+'\')">删除</button>\n' +
                '                    </div>')
        }
    }

    $('#shareExpiration').mousemove(function(){
        var num = $("#shareExpiration").val()
        var customRange2 = $("#shareExpiration2")
        customRange2.empty()
        if (num === "0") {
            customRange2.append("永久")
        } else {
            customRange2.append(num+"天")
        }
    });

    $('#shareIsPassword').change(function() {
        var shareIsPassword2 = $('#shareIsPassword2')
        shareIsPassword2.empty()
        if(this.checked) {
            var num = getRandomInt(100000, 999999)
            shareIsPassword2.append(num)
        }
    });

    // 生成一个0到1之间的随机小数
    var randomNum = Math.random();

    // 生成一个范围在[min, max]之间的随机整数
    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    $('#addShareExpiration').click(function (){
        console.log("addShareExpiration")
        var shareExpiration = $("#shareExpiration")
        var num = shareExpiration.val()
        num = Number(num)
        if (num < 365) {
            num = num+1
        }
        shareExpiration.val(num)
        var customRange2 = $("#shareExpiration2")
        customRange2.empty()
        if (num === "0" || num === 0) {
            customRange2.append("永久")
        } else {
            customRange2.append(num+"天")
        }
    })

    $('#cutShareExpiration').click(function (){
        var shareExpiration = $("#shareExpiration")
        var num = shareExpiration.val()
        num = Number(num)
        if (num > 0) {
            num = num-1
        }
        shareExpiration.val(num)
        var customRange2 = $("#shareExpiration2")
        customRange2.empty()
        if (num === "0" || num === 0) {
            customRange2.append("永久")
        } else {
            customRange2.append(num+"天")
        }
    })

    function projectShare() {
        createShare(1, projectId)
    }

    function docShare() {
        var docId = $("#shareDocId").val()
        createShare(2, docId)
    }

    function createShare(shareType, shareId) {
        var isPassword = 0;
        var passwordCode = $("#shareIsPassword2").text();
        if (passwordCode !== "") {
            isPassword = 1
        }

        var param = {
            "projectId": projectId,
            "shareType": shareType,
            "shareId": shareId,
            "expiration": Number($("#shareExpiration").val()),
            "isPassword": isPassword,
            "passwordCode": passwordCode,
        }

        AjaxPost("/share/create", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0 ) {
                shareListLoad(shareType, shareId)
                $("#shareExpiration").val(0);
                $("#shareIsPassword").prop('checked', false);
                $("#shareExpiration2").empty();
                $("#shareExpiration2").append("永久");
                $("#shareIsPassword2").empty();
            }
        });
    }

    function delShare(key) {
        AjaxGetNotAsync("/share/del?key="+key, function (data) {
            console.log(data)
            if (data.code === 0) {
                shareListLoad(data.data.shareType, data.data.shareId)
            }
        })
    }

    function cpShare(url) {
        copyContent(url)
        ToastShow("已复制到剪切板");
    }

    function delDir(dirId) {
        var param = {
            "pid": projectId,
            "dirId": dirId,
        }

        AjaxPost("/document/dir/delete", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0) {
                localStorage.setItem(dirOpenKey+data.data, 1)
                location.reload();
            }
        })

    }

    $( '#dirSortWrap' ).DDSort({
        target: 'li',
        floatStyle: {}
    });

    function sortDir() {
        AjaxPost("/document/dir/all?pid="+projectId, "",function (data){
            $("#dirSortWrap ul").empty();
            for(var i=0; i<data.data.length; i++) {
                $("#dirSortWrap ul").append('<li class="list-group-item list-group-item-action" data-id="'+data.data[i].dirId+'">{{ SVG "folder" 21 21 }} '+data.data[i].dirName+'</li>');
            }
            $('#dirSortModal').modal('show');
        });
    }

    function dirSortSubmit() {
        var dirList = $('#dirSortWrap li').map(function() {
            return $(this).attr("data-id");
        }).get();

        var param = {
            "pid": projectId,
            "dirList": dirList,
        }

        AjaxPost("/document/dir/sort", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0) {
                location.reload();
            }
        })
    }

    $( '#docSortWrap' ).DDSort({
        target: 'li',
        floatStyle: {}
    });

    function sortDoc(dirId) {

        var param = {
            "pid": projectId,
            "dirId": dirId,
        }

        AjaxPost("/document/doc/all", param,function (data){
            console.log(data)
            $("#docSortDirId").val(dirId);
            $("#docSortWrap ul").empty();
            for(var i=0; i<data.data.length; i++) {
                var methodtxt = ""
                switch (data.data[i].method) {
                    case "GET":methodtxt = GETSpan;break;
                    case "DELETE":methodtxt = DELETESpan;break;
                    case "POST":methodtxt = POSTSpan;break;
                    case "HEAD":methodtxt = HEADSpan;break;
                    case "PUT":methodtxt = PUTSpan;break;
                    case "OPTIONS":methodtxt = OPTIONSSpan;break;
                }
                $("#docSortWrap ul").append('<li class="list-group-item list-group-item-action" data-id="'+data.data[i].docId+'">'+methodtxt+ " "+data.data[i].title+'</li>');
            }

            $('#docSortModal').modal('show');

        });
    }

    function docSortSubmit() {
        var dirId = $("#docSortDirId").val();
        var docList = $('#docSortWrap li').map(function() {
            return $(this).attr("data-id");
        }).get();
        console.log(dirId)
        console.log(docList)

        var param = {
            "pid": projectId,
            "dirId": dirId,
            "docList": docList,
        }

        AjaxPost("/document/sort", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0) {
                location.reload();
            }
        })
    }

    function searchDoc() {
        var word = $("#searchWord").val();

        var param = {
            "pid": projectId,
            "word": word,
        }

        AjaxPost("/document/search", param, function (data) {

            if (data.code === 0) {
                $("#wrap").hide();

                $("#searchWrap ul").empty();
                $("#searchCount").empty();

                $("#searchCount").append("搜索到"+data.data.count+"条结果")
                for (var i=0; i<data.data.list.length; i++) {
                    console.log(data.data.list[i])
                    $("#searchWrap ul").append(docLiSearch(data.data.list[i].docId, data.data.list[i].method,
                        data.data.list[i].title, data.data.list[i].modType, data.data.list[i].word))
                }

                $("#searchWrap").show();

            }
        })
    }

    function returnDirList() {
        $("#wrap").show();
        $("#searchWrap").hide();
    }

</script>
<script type="text/javascript" src="/js/doc.js?v={{ .TimeStamp }}"></script>
{{ template "end" . }}