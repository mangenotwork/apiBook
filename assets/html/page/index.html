{{ template "head" . }}
<body>
{{ template "header" . }}

<div class="container-fluid">
    <div class="row">
    {{ template "api_dir" . }}
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" style="background-color: #ffffff;">
        
        <div class="box" style="margin-top: 8px;border: 1px solid #D3D3D3; border-radius: 4px;">
            <ul class="nav nav-tabs" id="docViewTable" style="width: 100%;height:54px;flex-direction: row;flex-wrap: nowrap;overflow-x: scroll;font-size: 11px;">
            </ul>
              <div id="doc" style="width: 100%; height: calc(100vh - 136px);background-color: #ffffff;overflow: auto;padding: 16px;position: relative;">

                <div class="row">

                    <div class="col-10">

                        <div id="notDocMain" style="display: none;">
                            <button type="button" class="btn btn-dark btn-lg" onclick="newAPIDoc('')">创建文档</button>
                        </div>


                      <div data-bs-spy="scroll" id="docMain" data-bs-target="#simple-list-example" data-bs-offset="0" data-bs-smooth-scroll="true"
                           class="scrollspy-example" style="margin-top: .5rem;overflow: auto; padding-left: 22px;" tabindex="0">

                          <nav aria-label="breadcrumb" id="docNav" style="display: none">
                              <ol class="breadcrumb">
                                  <li class="breadcrumb-item" id="returnLink"> <a href="javascript:void(0);" onclick="window.location.reload();">返回文档</a></li>
                                  <li class="breadcrumb-item active" aria-current="page" id="docNavSnapshot">镜像:xxxxx</li>
                              </ol>
                          </nav>

                          <div style="margin-bottom: 52px;margin-top: 16px;">
                            <h4 id="simple-list-item-1" style="margin-bottom: 16px;">基本信息</h4>
                            <div class="card">
                                <div class="card-body">
                                    <span id="docIdContent" style="display: none;"></span>
                                    <ul style="padding: 0;">
                                        <li style="padding: 8px;"><span class="txt7">接口名:</span><span id="api-name" style="font-size: 21px;margin-left: 16px;"></span></li>
                                        <li style="padding: 8px;"><span class="txt7">接口Url: </span>
                                            <span style="font-size: 21px;margin-left: 16px;">
                                                <span id="api-method"></span>
                                                <span id="api-url"></span>
                                            </span>
                                        </li>
                                        <li style="padding: 8px;"><span class="txt7">操作： </span><div class="btn-group" role="group" aria-label="Basic outlined example" style="margin-left: 16px;">
                                            <button type="button" class="btn btn-outline-dark" onclick="modifyDocContent()">编辑</button>
                                            <button type="button" class="btn btn-outline-dark">请求</button>
                                            <button type="button" class="btn btn-outline-dark" onclick="openDocShare()">分享</button>
                                            <button type="button" class="btn btn-outline-dark">Mock</button>
                                            <a type="button" class="btn btn-outline-dark" href="https://www.zhaozhongtian.top" target="_blank">在线工具</a>
                                          </div></li>
                                    </ul>
                                </div>
                            </div>
                          </div>

                        <div style="margin-bottom: 52px;">
                            <h4 id="simple-list-item-2" style="margin-bottom: 36px;">接口说明</h4>

                            <div class="card">
                                <div class="card-body" id="api-description"></div>
                            </div>
                        </div>
                        <div style="margin-bottom: 52px;">
                            <h4 id="simple-list-item-3" style="margin-bottom: 36px;">请求Header</h4>
                            <table class="table table-bordered table-hover table-striped">
                                <thead>
                                <tr>
                                    <th scope="col" class="docth" style="width: 20%;">字段</th>
                                    <th scope="col" class="docth" style="width: 5%;">类型</th>
                                    <th scope="col" class="docth" style="width: 5%;">必填</th>
                                    <th scope="col" class="docth" style="width: 20%;">描述</th>
                                    <th scope="col" class="docth" style="width: 20%;">示例</th>
                                </tr>
                                </thead>
                                <tbody id="api-reqHeader">
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-bottom: 52px;">
                            <h4 id="simple-list-item-4" style="margin-bottom: 36px;">请求参数</h4>
                            <p>请求数据类型: <span id="api-reqType">json</span></p>
                            <p>示例:</p>
                            <div id="jsoneditorDiv" style="display: none;">
                                <button type="button" class="btn btn-dark closeReqZsText"
                                        style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;margin-top: 2px;" onclick="closeReqZsText()">
                                    关闭注释
                                </button>
                                <button type="button" class="btn btn-dark openReqZsText"
                                        style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;margin-top: 2px; display: none;" onclick="openReqZsText()">
                                    开启注释
                                </button>
                                <button type="button" class="btn btn-dark"
                                        style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;margin-top: 2px;" onclick="copyReqJson()">
                                    复制
                                </button>
                                <a type="button" class="btn btn-dark"
                                        style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;margin-top: 2px;" href="https://www.zhaozhongtian.top/code-json" target="_blank">
                                    在线json工具
                                </a>
                                <div id="jsoneditor" style="width: 100%;margin-bottom: 16px;margin-top: 8px;"></div>
                            </div>
                            <p>参数说明:</p>
                              <table class="table table-bordered table-hover table-striped" style="table-layout:fixed;display:table;">
                                  <thead>
                                  <tr>
                                      <th scope="col" class="docth" style="width: 20%;">字段</th>
                                      <th scope="col" class="docth" style="width: 5%;">类型</th>
                                      <th scope="col" class="docth" style="width: 5%;">必填</th>
                                      <th scope="col" class="docth" style="width: 20%;">描述</th>
                                      <th scope="col" class="docth" style="width: 20%;">示例</th>
                                  </tr>
                                  </thead>
                                  <tbody id="api-reqBodyInfo">
                                  </tbody>
                              </table>
                        </div>

                        <div style="margin-bottom: 52px;">
                            <h4 id="simple-list-item-5"  style="margin-bottom: 36px;">响应</h4>
                            <p>请求数据类型: <span id="api-respType">json</span></p>
                            <p>示例:</p>
                            <div id="jsoneditorRespDiv" style="display: none;">
                                <button type="button" class="btn btn-dark closeRespZsText"
                                        style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;margin-top: 2px;" onclick="closeRespZsText()">
                                    关闭注释
                                </button>
                                <button type="button" class="btn btn-dark openRespZsText"
                                        style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;margin-top: 2px; display: none;" onclick="openRespZsText()">
                                    开启注释
                                </button>
                                <button type="button" class="btn btn-dark"
                                        style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;margin-top: 2px;" onclick="copyRespJson()">
                                    复制
                                </button>
                                <a type="button" class="btn btn-dark"
                                   style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;margin-top: 2px;" href="https://www.zhaozhongtian.top/code-json" target="_blank">
                                    在线json工具
                                </a>
                                <div id="jsoneditorResp" style="width: 100%;margin-bottom: 16px;margin-top: 8px;"></div>
                            </div>

                            <p>参数说明:</p>
                            <table class="table table-bordered table-hover table-striped" style="table-layout:fixed;display:table;">
                                <thead>
                                <tr>
                                    <th scope="col" class="docth" style="width: 20%;">字段</th>
                                    <th scope="col" class="docth" style="width: 5%;">类型</th>
                                    <th scope="col" class="docth" style="width: 20%;">描述</th>
                                    <th scope="col" class="docth" style="width: 20%;">示例</th>
                                </tr>
                                </thead>
                                <tbody id="api-respBodyInfo">
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-bottom: 52px;">
                            <h4 id="simple-list-item-7">请求代码</h4>
                            todo....
                        </div>

                        <div style="margin-bottom: 52px;">
                            <h4 id="simple-list-item-6">日志&镜像</h4>
                            <ul class="list-group list-group-flush" id="snapshot">
                            </ul>
                            </div>
                      </div>
                    </div>

                    <div class="col-2" id="docMainML">
                        <div id="simple-list-example" class="d-flex flex-column gap-2 simple-list-example-scrollspy text-center">
                          <a class="p-1 rounded" style="color: #1a1d20;text-decoration: none;" href="#simple-list-item-1">基本信息</a>
                          <a class="p-1 rounded" style="color: #1a1d20;text-decoration: none;" href="#simple-list-item-2">接口说明</a>
                          <a class="p-1 rounded" style="color: #1a1d20;text-decoration: none;" href="#simple-list-item-3">请求Header</a>
                          <a class="p-1 rounded" style="color: #1a1d20;text-decoration: none;" href="#simple-list-item-4">请求Body</a>
                          <a class="p-1 rounded" style="color: #1a1d20;text-decoration: none;" href="#simple-list-item-5">响应</a>
                          <a class="p-1 rounded" style="color: #1a1d20;text-decoration: none;" href="#simple-list-item-7">请求代码</a>
                          <a class="p-1 rounded" style="color: #1a1d20;text-decoration: none;" href="#simple-list-item-6">日志&镜像</a>
                        </div>
                    </div>

                  </div>


              </div>
        </div>

        {{ template "toast" . }}
        {{ template "ProjectModalAdd" . }}
        {{ template "ApiDocAddModal" . }}
        {{ template "DocAddDirModal" . }}
        {{ template "GlobalCodeModal" . }}
        {{ template "GlobalHeaderModal" . }}
        {{ template "ShareModal" . }}

    </main>

    </div>
</div>

</body>

{{ template "pubjs" . }}
<script>

    var editorAdd = {}
    var editorAddResp = {}

    var projectId = "{{ .projectId }}"
    var dirId = ""

    var editormdObj = editormd("test-editor", {
        markdown: "",
        height: 440,
        width: "100%",
        path: '/js/lib/',
        htmlDecode : "style,script,iframe|on*",
        imageUpload : true,
        imageFormats : ["jpg", "jpeg", "gif", "png", "bmp"],
        imageUploadURL : "url",
        saveHTMLToTextarea : true,
    });

    var reqType = "json"
    var respType = "json"

    var zs = {}
    var zsresp = []

    const container = document.getElementById("jsoneditor")
    const options = {
        mode: 'view',
    }
    var editor = new JSONEditor(container, options)

    const containerResp = document.getElementById("jsoneditorResp")
    const optionsResp = {
        mode: 'view',
    }
    var editorResp = new JSONEditor(containerResp, optionsResp)

    const containerAdd = document.getElementById("jsoneditorAdd")
    const optionsAdd = {
        mode: 'code',
    }
    var editorAdd = new JSONEditor(containerAdd, optionsAdd)


    const containerAddResp = document.getElementById("jsoneditorAddResp")
    const optionsAddResp = {
        mode: 'code',
    }
    var editorAddResp = new JSONEditor(containerAddResp, optionsAddResp)

    $(document).on('click', '.dir-open', function() {
        var open = $(this).attr('data-open');
        var dirid = $(this).attr('data-dirid');
        $(this).find('span').empty();
        if (open === "0") {
            $(this).find('span').append('{{ SVG "folder2-open" 21 21 }}');
            $(this).attr('data-open', '1');
            $('#'+dirid).show();
            localStorage.setItem(dirOpenKey+dirid,1)
        } else {
            $(this).find('span').append('{{ SVG "folder" 21 21 }}');
            $(this).attr('data-open', '0');
            $('#'+dirid).hide();
            localStorage.setItem(dirOpenKey+dirid,0)
        }
    });

    $(document).on('hover', '.docli', function() {
        $(this).css('background-color', '#f6f6f6');
    });

    $(document).on('mouseenter', '.hover-area', function() {
        $(this).find('.action-btn').show();
        $(this).css({
            'height':'72px',
        })
    }).on('mouseleave', '.hover-area', function() {
        $(this).find('.action-btn').hide();
        $(this).css({
            'height':'38px',
        })
    });


    $(document).on('mouseenter', '.dir', function() {
        tippyInit();
        $(this).find('.dirop').show();
        $(this).css({
            'height':'72px',
        })
    }).on('mouseleave', '.dir', function() {
        $(this).find('.dirop').hide();
        $(this).css({
            'height':'42px',
        })
    });

    function isShow(is) {
        if (is) {
            $("#docMain").show();
            $("#docMainML").show();
            $("#notDocMain").hide();
        } else {
            $("#docMain").hide();
            $("#docMainML").hide();
            $("#notDocMain").show();
        }
    }

    $(document).ready(function(){
        tippyInit();
        $('#newSort').click(function(){
            var ulValue = $( '#wrap' ).children();
            console.log(ulValue)
            for (var i=0; i<ulValue.length; i++) {
                var liValue = ulValue[i].children
                console.log(liValue)
                for(var j=0; j<liValue.length;j++) {
                    console.log(liValue[j])
                }
            }
        });

        AjaxGet("/document/dir/list?pid="+projectId, function(data){
            if (data.code === 0 ) {
                var apiDir = data.data
                for(var item in apiDir) {
                    if (apiDir.hasOwnProperty(item)){
                        var dirId = apiDir[item].dir.dirId;
                        var dirname = apiDir[item].dir.name;
                        var doc = apiDir[item].doc;
                        $("#wrap").append(dirDev(dirId, dirname))
                        $("#addDocDir").append(addDocDirOption(dirId, dirname))
                        for(var li in doc) {
                            if (doc.hasOwnProperty(li)) {
                                $("#"+dirId).append(docLi(doc[li].docId, doc[li].method, doc[li].title))
                            }
                        }
                    }
                }
            }
        });

        var viewDocList = viewDocGet(projectId)

        var param = {
            "pid": projectId,
            "docList": viewDocList,
        }

        if(localStorage.getItem(nowViewDoc+projectId) === "undefined" || localStorage.getItem(nowViewDoc+projectId)=== null) {
            isShow(false)
        }

        AjaxPost("/document/doc/list", param, function(data){
            if (data.code === 0 ) {
                for(var i=0; i<data.data.length; i++) {
                    if(data.data[i].docId === localStorage.getItem(nowViewDoc+projectId)) {
                        NowDoc(data.data[i].docId)
                    } else {
                        showViewDoc(data.data[i].method, data.data[i].name, data.data[i].docId, false)
                    }
                }
            }
        })

        $('#apiDocAddModal').on('shown.bs.modal', function () {
            console.log("apiDocAddModal shown.bs.modal")
            editormdObj = editormd("test-editor", {
                markdown: "",
                height: 440,
                width: "100%",
                path: '/js/lib/',
                htmlDecode : "style,script,iframe|on*",
                imageUpload : true,
                imageFormats : ["jpg", "jpeg", "gif", "png", "bmp"],
                imageUploadURL : "url",
                saveHTMLToTextarea : true,
            });

        });

    });

    function openBodyMain(type) {
        var bodyJson = $("#bodyJson");
        var bodyFromData = $("#bodyFromData");
        var bodyXwwwFrom = $("#bodyXwwwFrom");
        var bodyXml = $("#bodyXml");
        var bodyText = $("#bodyText");
        var bodyGo = $("#bodyGo");
        var bodyTs = $("#bodyTs");

        var openBodyBtnJson = $("#openBodyBtn-json");
        var openBodyBtnFromData = $("#openBodyBtn-from-data");
        var openBodyBtnXWwwFormUrlencoded = $("#openBodyBtn-x-www-form-urlencoded");
        var openBodyBtnXml = $("#openBodyBtn-xml")
        var openBodyBtnPlain = $("#openBodyBtn-plain")
        var openBodyBtnGo = $("#openBodyBtn-go")
        var openBodyBtnTs = $("#openBodyBtn-ts")

        bodyJson.hide();
        bodyFromData.hide();
        bodyXwwwFrom.hide();
        bodyXml.hide();
        bodyText.hide();
        bodyGo.hide();
        bodyTs.hide();

        openBodyBtnJson.removeClass('btn-light');
        if (!openBodyBtnJson.hasClass('btn-dark')) {
            openBodyBtnJson.addClass('btn-dark')
        }

        openBodyBtnFromData.removeClass('btn-light');
        if (!openBodyBtnFromData.hasClass('btn-dark')) {
            openBodyBtnFromData.addClass('btn-dark')
        }

        openBodyBtnXWwwFormUrlencoded.removeClass('btn-light');
        if (!openBodyBtnXWwwFormUrlencoded.hasClass('btn-dark')) {
            openBodyBtnXWwwFormUrlencoded.addClass('btn-dark')
        }

        openBodyBtnXml.removeClass('btn-light');
        if (!openBodyBtnXml.hasClass('btn-dark')) {
            openBodyBtnXml.addClass('btn-dark')
        }

        openBodyBtnPlain.removeClass('btn-light');
        if (!openBodyBtnPlain.hasClass('btn-dark')) {
            openBodyBtnPlain.addClass('btn-dark')
        }

        openBodyBtnGo.removeClass('btn-light');
        if (!openBodyBtnGo.hasClass('btn-dark')) {
            openBodyBtnGo.addClass('btn-dark')
        }

        openBodyBtnTs.removeClass('btn-light');
        if (!openBodyBtnTs.hasClass('btn-dark')) {
            openBodyBtnTs.addClass('btn-dark')
        }

        switch (type) {
            case 'json':
                bodyJson.show();
                openBodyBtnJson.removeClass('btn-dark');
                openBodyBtnJson.addClass('btn-light')
                reqType = "json"
                break
            case 'from-data':
                bodyFromData.show();
                openBodyBtnFromData.removeClass('btn-dark');
                openBodyBtnFromData.addClass('btn-light')
                reqType = "from-data"
                break
            case 'x-www-form-urlencoded':
                bodyXwwwFrom.show();
                openBodyBtnXWwwFormUrlencoded.removeClass('btn-dark');
                openBodyBtnXWwwFormUrlencoded.addClass('btn-light')
                reqType = "x-www-form-urlencoded"
                break
            case 'xml':
                bodyXml.show();
                openBodyBtnXml.removeClass('btn-dark');
                openBodyBtnXml.addClass('btn-light')
                reqType = "xml"
                break
            case 'plain':
                bodyText.show();
                openBodyBtnPlain.removeClass('btn-dark');
                openBodyBtnPlain.addClass('btn-light')
                reqType = "text"
                break
            case 'go':
                bodyGo.show();
                openBodyBtnGo.removeClass('btn-dark');
                openBodyBtnGo.addClass('btn-light')
                reqType = "json"
                break
            case 'ts':
                bodyTs.show();
                openBodyBtnTs.removeClass('btn-dark');
                openBodyBtnTs.addClass('btn-light')
                reqType = "json"
                break
        }
    }

    function openRespMain(type) {
        var respJson = $("#respJson")
        var respXml = $("#respXml")
        var respText = $("#respText")
        var respGo = $("#respGo");
        var respTs = $("#respTs");

        var openRespBtnJson = $("#openRespBtn-json")
        var openRespBtnXml = $("#openRespBtn-xml")
        var openRespBtnPlain = $("#openRespBtn-plain")
        var openRespBtnGo = $("#openRespBtn-go")
        var openRespBtnTs = $("#openRespBtn-ts")

        respJson.hide();
        respXml.hide();
        respText.hide();
        respGo.hide();
        respTs.hide();

        openRespBtnJson.removeClass('btn-light');
        if (!openRespBtnJson.hasClass('btn-dark')) {
            openRespBtnJson.addClass('btn-dark')
        }

        openRespBtnXml.removeClass('btn-light');
        if (!openRespBtnXml.hasClass('btn-dark')) {
            openRespBtnXml.addClass('btn-dark')
        }

        openRespBtnPlain.removeClass('btn-light');
        if (!openRespBtnPlain.hasClass('btn-dark')) {
            openRespBtnPlain.addClass('btn-dark')
        }

        openRespBtnGo.removeClass('btn-light');
        if (!openRespBtnGo.hasClass('btn-dark')) {
            openRespBtnGo.addClass('btn-dark')
        }

        openRespBtnTs.removeClass('btn-light');
        if (!openRespBtnTs.hasClass('btn-dark')) {
            openRespBtnTs.addClass('btn-dark')
        }

        switch (type) {
            case 'json':
                respJson.show();
                openRespBtnJson.removeClass('btn-dark');
                openRespBtnJson.addClass('btn-light')
                respType = "json"
                break
            case 'xml':
                respXml.show();
                openRespBtnXml.removeClass('btn-dark');
                openRespBtnXml.addClass('btn-light')
                respType = "xml"
                break
            case 'plain':
                respText.show();
                openRespBtnPlain.removeClass('btn-dark');
                openRespBtnPlain.addClass('btn-light')
                respType = "text"
                break
            case 'go':
                respGo.show();
                openRespBtnGo.removeClass('btn-dark');
                openRespBtnGo.addClass('btn-light')
                respType = "json"
                break
            case 'ts':
                respTs.show();
                openRespBtnTs.removeClass('btn-dark');
                openRespBtnTs.addClass('btn-light')
                respType = "json"
                break
        }
    }

    $(document).on('click', '.headerRemove', function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#setHeaderTable tr:eq('+index+')').remove();
    });

    function saveAddDoc(submitType) {

        if($("#addDocName").val() === "") {
            ToastShow("文档名不能为空!");
            return
        }

        if($("#addDocUrl").val() === "") {
            ToastShow("接口Url不能为空!");
            return
        }

        var reqHeader = []
        var reqBodyInfo = []
        var respInfo = []

        var headerField = $('.addDocHeaderField').map(function() {
            return $(this).val();
        }).get();
        var headerIsRequired = $('.addDocHeaderIsRequired').map(function() {
            return $(this).val();
        }).get();
        var headerVarType = $('.addDocHeaderVarType').map(function() {
            return $(this).val();
        }).get();
        var headerDescription = $('.addDocHeaderDescription').map(function() {
            return $(this).val();
        }).get();
        var headerExample = $('.addDocHeaderExample').map(function() {
            return $(this).val();
        }).get();
        for (var i=0; i<headerField.length; i++) {
            reqHeader.push({
                "field":  headerField[i],     // 字段
                "varType":  headerVarType[i],   // 类型
                "description": headerDescription[i], // 描述
                "example": headerExample[i],    // 示例
                "isRequired":  Number(headerIsRequired[i]), // 是否必填 1:必填
                "sort": i,        // 排序
            })
        }

        var reqField = $('.reqField').map(function() {
            return $(this).val();
        }).get();

        var reqDescription = $('.reqDescription').map(function() {
            return $(this).val();
        }).get();

        var reqVarType = $('.reqVarType').map(function() {
            return $(this).val();
        }).get();

        var reqExample = $('.reqExample').map(function() {
            return $(this).val();
        }).get();

        var reqIsRequired = $('.reqIsRequired').map(function() {
            return $(this).val();
        }).get();

        for (var i=0; i<reqField.length; i++) {
            reqBodyInfo.push({
                "field": reqField[i],
                "varType":  reqVarType[i],    // 类型
                "description": reqDescription[i], // 描述
                "example":  reqExample[i],   // 示例
                "isRequired":  Number(reqIsRequired[i]), // 是否必填 1:必填
                "sort": i,        // 排序
            })
        }

        var respField = $('.respField').map(function() {
            return $(this).val();
        }).get();

        var respDescription = $('.respDescription').map(function() {
            return $(this).val();
        }).get();

        var respVarType = $('.respVarType').map(function() {
            return $(this).val();
        }).get();

        var respExample = $('.respExample').map(function() {
            return $(this).val();
        }).get();

        for (var i=0; i<respField.length; i++) {
            respInfo.push({
                "field":  respField[i],   // 字段
                "varType":   respVarType[i],  // 类型
                "description":  respDescription[i], // 描述
                "example":     respExample[i],  // 示例
                "sort": i,       // 排序
            })
        }

        var respBody = ""
        if (respType === "json") {
            respBody = JSON.stringify(editorAddResp.get())
        }
        if (respType === "xml") {
            respBody = $("#respXml").val()
        }
        if (respType === "text") {
            respBody = $("#respText").val()
        }

        var docId = "";
        if(submitType === 2) {
            docId = $("#operateDocId").val()
        }

        var param = {
            "projectId": projectId,
            "dirId": $("#addDocDir").val(),
            "content": {
                "docId": docId,
                "projectId": projectId,
                "name": $("#addDocName").val(),
                "url": $("#addDocUrl").val(),
                "method": $("#addDocMethod").val(),
                "description": editormdObj.getMarkdown(),
                "descriptionHtml": editormdObj.getPreviewedHTML(),
                "reqHeader": reqHeader,      // 请求头 []*ReqHeaderItem
                "reqType": reqType,                  // 请求类型
                "reqBodyJson": JSON.stringify(editorAdd.get()),              // 请求参数 - json
                "reqBodyText": $("#bodyText").val(),               // 请求参数 - text
                "reqBodyXml": $("#bodyXml").val(),     // 请求参数 - xml
                "reqBodyInfo": reqBodyInfo,              // 请求参数说明   []*BodyInfoItem
                "respType": respType,
                "resp": [{
                    "tag": "成功",      // 默认 成功
                    "respType": respType, // 响应类型
                    "respBody" : respBody,                // 请求响应 - json
                    "respBodyInfo": reqBodyInfo,
                }],
            }
        }

        if(submitType === 2) {
            console.log("编辑文档提交")
            console.log(param)
            AjaxPost("/document/modify", param, function (data){
                ToastShow(data.msg);
                if (data.code === 0) {
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                }
            });
        }else {
            AjaxPost("/document/create", param, function (data){
                ToastShow(data.msg);
                if (data.code === 0) {
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                }
            });
        }


    }

    function jsonToBodyInfoItem(jsonObj, parentKey) {
        var jsonInfo = jsonObj
        for (var key in jsonInfo) {
            var reqField = $('.reqField').map(function() {
                return $(this).val();
            }).get();

            var reqVarType = $('.reqVarType').map(function() {
                return $(this).val();
            }).get();

            var reqExample =  $('.reqExample').map(function() {
                return $(this).val();
            }).get();

            var keyType = typeof jsonInfo[key]
            if (keyType === "object") {
                keyType = isArrayOrObject(jsonInfo[key])
            }
            if (keyType === "string" && jsonInfo[key].length > 188) {
                jsonInfo[key] = jsonInfo[key].substring(0,188)+"..."
            }
            var flag = false
            for (var has in reqField) {
                if (reqField[has] === key) {
                    if (reqVarType[has] !== keyType) {
                        $('.reqVarType:eq('+has+')').val(keyType);
                    }
                    if (reqExample[has] !== jsonInfo[key]) {
                        $('.reqExample:eq('+has+')').val(jsonInfo[key]);
                    }
                    flag = true
                }
            }
            var field = key
            if (parentKey !== "") {
                field = parentKey+"."+key
            }
            if (!flag && reqField[0] === "") {
                $(".reqField").first().val(field);
                $(".reqVarType").first().val(keyType);
                $(".reqExample").first().val(jsonInfo[key]);
            } else if (!flag) {
                $("#setReqTable").append(addReqTpl(field, keyType, jsonInfo[key], "", "1"));
            }

            if (keyType === "object") {
                var newParentKey = parentKey
                if (newParentKey === "") {
                    newParentKey = key
                }else {
                    newParentKey = parentKey+ "."+key
                }
                jsonToBodyInfoItem(jsonInfo[key], newParentKey)
            }

            if (keyType === "array") {
                if (isArrayOrObject(jsonInfo[key][0]) === "object") {
                    var newParentKey = parentKey
                    if (newParentKey === "") {
                        newParentKey = key
                    } else {
                        newParentKey = parentKey+ "."+key
                    }
                    jsonToBodyInfoItem(jsonInfo[key][0], newParentKey)
                }
            }
        }
    }

    function jsonToBodyInfo() {
        var jsonInfo = editorAdd.get();
        console.log(jsonInfo)
        jsonToBodyInfoItem(jsonInfo, "")
    }

    $(document).on('click', '.addReq', function() {
        $("#setReqTable").append(addReqTpl("", "", "", "", "1"));
    });

    $(document).on('click', '.removeReq', function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#setReqTable tr:eq('+index+')').remove();
    });

    function jsonToRespInfoItem(jsonObj, parentKey) {
        var jsonInfo = jsonObj

        for (var key in jsonInfo) {

            var reqField = $('.respField').map(function() {
                return $(this).val();
            }).get();

            var reqVarType = $('.respVarType').map(function() {
                return $(this).val();
            }).get();

            var reqExample =  $('.respExample').map(function() {
                return $(this).val();
            }).get();

            var keyType = typeof jsonInfo[key]
            if (keyType === "object") {
                keyType = isArrayOrObject(jsonInfo[key])
            }
            if (keyType === "string" && jsonInfo[key].length > 188) {
                jsonInfo[key] = jsonInfo[key].substring(0,188)+"..."
            }
            var flag = false
            for (var has in reqField) {
                if (reqField[has] === key) {
                    if (reqVarType[has] !== keyType) {
                        $('.respVarType:eq('+has+')').val(keyType);
                    }
                    if (reqExample[has] !== jsonInfo[key]) {
                        $('.respExample:eq('+has+')').val(jsonInfo[key]);
                    }
                    flag = true
                }
            }

            var field = key
            if (parentKey !== "") {
                field = parentKey+"."+key
            }

            if (!flag && reqField[0] === "") {
                $(".respField").first().val(field);
                $(".respVarType").first().val(keyType);
                $(".respExample").first().val(jsonInfo[key]);
            } else if (!flag) {
                $("#setRespTable").append(addRespTpl(field, keyType, jsonInfo[key], ""));
            }

            if (keyType === "object") {
                var newParentKey = parentKey
                if (newParentKey === "") {
                    newParentKey = key
                }else {
                    newParentKey = parentKey+ "."+key
                }
                jsonToRespInfoItem(jsonInfo[key], newParentKey)
            }

            if (keyType === "array") {
                if (isArrayOrObject(jsonInfo[key][0]) === "object") {
                    var newParentKey = parentKey
                    if (newParentKey === "") {
                        newParentKey = key
                    } else {
                        newParentKey = parentKey+ "."+key
                    }
                    jsonToRespInfoItem(jsonInfo[key][0], newParentKey)
                }
            }
        }
    }

    function jsonToRespInfo() {
        var jsonInfo = editorAddResp.get();
        jsonToRespInfoItem(jsonInfo, "")
    }

    function showViewDoc(apiMethod, apiName, docId, isActive) {
        var docViewItem = $('.docViewItem').map(function() {
            return $(this).attr("data-docid");
        }).get();

        for (var i=0; i<docViewItem.length; i++) {
            if (docViewItem[i] === docId) {
                var docViewTable =  $("#docViewTable")
                docViewTable.find('a').each(function() {
                    $(this).removeClass("active")
                });
                $(".docViewItem[data-docid="+docId+"]").addClass("active")
                var x = ($(".docViewItem[data-docid="+docId+"]").offset().left-docViewTable.width())+400
                docViewTable.animate({
                    scrollLeft: x,
                }, 500);
                return
            }
        }

        var isActiveStr = ""
        if (isActive) {
            var docViewTable =  $("#docViewTable")
            docViewTable.find('a').each(function() {
                $(this).removeClass("active")
            });
            isActiveStr = "active"
        }
        $("#docViewTable").append(docViewItemTpl(isActiveStr, docId, apiMethod, apiName));
        $('#docViewTable').scrollLeft(9999);
    }

    $(document).on('click', '.addResp', function (){
        $("#setRespTable").append(addRespTpl("", "", "", ""));
    });

    $(document).on('click', '.removeResp', function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#setRespTable tr:eq('+index+')').remove();
    })

    function NowDoc(docId) {
        // 获取文档
        var param = {
            "pid": projectId,
            "docId": docId,
        }
        AjaxPostNotAsync("/document/item", param, function(data){
            if (data.code === 0 ) {
                localStorage.setItem(nowViewDoc+projectId, docId)
                showViewDoc(data.data.content.method, data.data.content.name, docId, true)
                loadApiDoc(data.data.content, data.data.snapshotList)
            }
        })
    }

    $(document).on('click', '.docli', function(event) {
        var docId = $(this).prop('id');
        isShow(true)
        viewDocAdd(projectId, docId)
        NowDoc(docId)
    })

    $(document).on('click', '.docViewItem', function (event){
        var docViewTable =  $("#docViewTable")
        docViewTable.find('a').each(function() {
            $(this).removeClass("active")
        });
        $(this).addClass("active")
        var x = ($(this).offset().left-docViewTable.width())+400
        docViewTable.animate({
            scrollLeft: x,
        }, 500);
        var docId = $(this).attr("data-docid")
        localStorage.setItem(nowViewDoc+projectId, docId)
        NowDoc(docId)
    })

    $(document).on('click', '.docViewClose', function (event){
        event.stopPropagation();
        var target = event.target;
        var index = $(target).parents("li").index();
        var now = $('#docViewTable li:eq('+index+')')

        if(now.find("a").hasClass("active")) {
            if (index>0) {
                var i = index-1
                $('#docViewTable li:eq('+i+')').find("a").addClass("active")
                var docId = $('#docViewTable li:eq('+i+')').find("a").attr("data-docid")
                localStorage.setItem(nowViewDoc+projectId, docId)
                NowDoc(docId)
            }else {
                var i = index+1
                $('#docViewTable li:eq('+i+')').find("a").addClass("active")
                var docId = $('#docViewTable li:eq('+i+')').find("a").attr("data-docid")
                localStorage.setItem(nowViewDoc+projectId, docId)
                NowDoc(docId)
            }
        }
        now.remove();

        var docId = now.find("a").attr("data-docid")

        viewDocDel(projectId, docId)

        if(localStorage.getItem(nowViewDoc+projectId) === "undefined") {
            isShow(false)
        }
    })

    function openAddDocDir() {
        $('#docAddDirModal').modal('show');
    }

    function addDocDir() {
        const url = "/document/dir/create"
        var param = {
            "pid": projectId,
            "dirName": $("#docAddDirName").val()
        }
        AjaxPost(url, param, function (data){
            ToastShow(data.msg);
            if (data.code === 0) {
                setTimeout(function() {
                    location.reload();
                }, 1000);
            }
        })
    }

    function loadApiDoc(apiDoc, snapshotList) {

        console.log(apiDoc)


        var docIdContent = $("#docIdContent")
        var apiName = $("#api-name")
        var apiMethod = $("#api-method")
        var apiUrl = $("#api-url")
        var apiDescription = $("#api-description")
        var apiReqHeader = $("#api-reqHeader")
        var apiReqType = $("#api-reqType")
        var apiReqBodyInfo = $("#api-reqBodyInfo")
        var apiRespType = $("#api-respType")
        var apiRespBodyInfo = $("#api-respBodyInfo")

        docIdContent.empty();
        apiName.empty();
        apiMethod.empty();
        apiUrl.empty();
        apiDescription.empty();
        apiReqHeader.empty();
        apiReqType.empty();
        apiReqBodyInfo.empty();
        apiRespType.empty();
        apiRespBodyInfo.empty();

        docIdContent.append(apiDoc.docId);
        apiName.append(apiDoc.name);

        var methodStr = ""
        switch (apiDoc.method) {
            case "GET":methodStr = GETSpan;break;
            case "DELETE":methodStr = DELETESpan;break;
            case "POST":methodStr = POSTSpan;break;
            case "HEAD":methodStr = HEADSpan;break;
            case "PUT":methodStr = PUTSpan;break;
            case "OPTIONS":methodStr = OPTIONSSpan;break;
        }
        apiMethod.append(methodStr);

        apiUrl.append(apiDoc.url);
        apiDescription.html(apiDoc.descriptionHtml);

        if ( apiDoc.reqHeader !== undefined ) {
            for(var i=0; i<apiDoc.reqHeader.length; i++) {
                apiReqHeader.append(apiReqHeaderTpl(apiDoc.reqHeader[i].field, apiDoc.reqHeader[i].varType, apiDoc.reqHeader[i].isRequired,
                    apiDoc.reqHeader[i].description, apiDoc.reqHeader[i].example))
            }
        }

        apiReqType.append(apiDoc.reqType);

        if ( apiDoc.reqBodyInfo !== undefined ) {
            for (var i = 0; i < apiDoc.reqBodyInfo.length; i++) {
                //console.log(apiDoc.reqBodyInfo[i])
                zs["jsonpath:" + apiDoc.reqBodyInfo[i].field.replace(/\./g, ",")] = apiDoc.reqBodyInfo[i].description
                apiReqBodyInfo.append(apiReqBodyInfoTpl(apiDoc.reqBodyInfo[i].field, apiDoc.reqBodyInfo[i].varType, apiDoc.reqBodyInfo[i].isRequired,
                    apiDoc.reqBodyInfo[i].description, apiDoc.reqBodyInfo[i].example, i))
                if (apiDoc.reqBodyInfo[i].example.length > 20) {
                    tippy('.reqExampleTxt' + i, {
                        content: apiDoc.reqBodyInfo[i].example
                    });
                }
                if (apiDoc.reqBodyInfo[i].description.length > 20) {
                    tippy('.reqDescriptionTxt' + i, {
                        content: apiDoc.reqBodyInfo[i].description
                    });
                }
            }
        }

        if (apiDoc.reqType === "json") {
            $("#jsoneditorDiv").show();
            const initialJson = JSON.parse(apiDoc.reqBodyJson)
            editor.set(initialJson)
            editor.expandAll()
            const updatedJson = editor.get()
            const paths = getJsonPaths(updatedJson);
            $("#jsoneditor").find(".jsoneditor-field").each(function() {
                var id = $(this).prop("id")
                var regex = new RegExp("0,", "g");
                id = id.replace(regex, "");
                if (zs[id]){
                    $(this).parent().parent().append('<td class="zsReqText zsText"> /* '+zs[id]+' */</td>')
                }
            })
        }

        if ( apiDoc.resp !== undefined && apiDoc.resp.length > 0 ) {
            apiRespType.append(apiDoc.resp[0].respType);
            if (apiDoc.resp[0].respBodyInfo != null) {
                for(var i=0; i<apiDoc.resp[0].respBodyInfo.length; i++) {
                    zsresp["jsonpath:"+apiDoc.resp[0].respBodyInfo[i].field.replace(/\./g, ",")] = apiDoc.resp[0].respBodyInfo[i].description
                    apiRespBodyInfo.append(apiRespBodyInfoTpl(apiDoc.resp[0].respBodyInfo[i].field, apiDoc.resp[0].respBodyInfo[i].varType,
                        apiDoc.resp[0].respBodyInfo[i].description, apiDoc.resp[0].respBodyInfo[i].example, i))
                    if(apiDoc.resp[0].respBodyInfo[i].example.length > 20) {
                        tippy('.respExampleTxt'+i, {
                            content: apiDoc.resp[0].respBodyInfo[i].example
                        });
                    }
                    if(apiDoc.resp[0].respBodyInfo[i].description.length>20) {
                        tippy('.respDescriptionTxt'+i, {
                            content: apiDoc.resp[0].respBodyInfo[i].description
                        });
                    }
                }
            }

            if (apiDoc.resp[0].respType === "json" && apiDoc.resp[0].respBody !== "") {
                $("#jsoneditorRespDiv").show();
                const initialJson = JSON.parse(apiDoc.resp[0].respBody)
                editorResp.set(initialJson)
                editorResp.expandAll()
                const updatedJson = editorResp.get()
                const paths = getJsonPaths(updatedJson);
                $("#jsoneditorResp").find(".jsoneditor-field").each(function() {
                    var id = $(this).prop("id")
                    var regex = new RegExp("0,", "g");
                    id = id.replace(regex, "");
                    if (zsresp[id]){
                        $(this).parent().parent().append('<td class="zsRespText zsText"> /* '+zsresp[id]+' */</td>')
                    }
                })
            }

            var snapshot = $("#snapshot");
            snapshot.empty()
            if (snapshotList != null) {
                for (var i=0; i< snapshotList.length; i++) {
                    snapshot.append('<li class="list-group-item" style="font-size: 12px;">'+ snapshotList[i].userAcc+ ' - ' + snapshotList[i].createTimeStr+
                        ' - ' + snapshotList[i].operation + ' | 镜像: <a type="button" class="btn btn-link" ' +
                        'onclick="openSnapshot(\''+apiDoc.docId+'\',\''+snapshotList[i].snapshotId+'\')">' + snapshotList[i].snapshotId +'</a> </li>')
                }
            }

        }



    }

    function closeReqZsText() {
        $(".zsReqText").remove();
        $(".closeReqZsText").hide();
        $(".openReqZsText").show();
    }

    function closeRespZsText() {
        $(".zsRespText").remove();
        $(".closeRespZsText").hide();
        $(".openRespZsText").show();
    }

    function openReqZsText() {
        $("#jsoneditor").find(".jsoneditor-field").each(function() {
            var id = $(this).prop("id")
            var regex = new RegExp("0,", "g");
            id = id.replace(regex, "");
            if (zs[id]){
                $(this).parent().parent().append('<td class="zsReqText zsText"> /* '+zs[id]+' */</td>')
            }
        })
        $(".closeReqZsText").show();
        $(".openReqZsText").hide();
    }

    function openRespZsText() {
        $("#jsoneditorResp").find(".jsoneditor-field").each(function() {
            var id = $(this).prop("id")
            var regex = new RegExp("0,", "g");
            id = id.replace(regex, "");
            if (zsresp[id]){
                $(this).parent().parent().append('<td class="zsRespText zsText"> /* '+zsresp[id]+' */</td>')
            }
        })
        $(".closeRespZsText").show();
        $(".openRespZsText").hide();
    }

    function copyReqJson() {
        var jsonObj =  editor.get()
        copyContent(JSON.stringify(jsonObj))
    }

    function copyRespJson() {
        var jsonObj =  editorResp.get()
        copyContent(JSON.stringify(jsonObj))
    }

    function goToRespInfo() {
        const url = "/tool/goStructToField"
        var param = {
            "text": $("#respGo textarea").val(),
        }
        AjaxPost(url, param, function (data){

            delRespTpl();

            for(var i=0; i<data.data.length; i++) {

                var respField = $('.respField').map(function() {
                    return $(this).val();
                }).get();

                if (respField[0] === "") {
                    $(".respField").first().val(data.data[i].field);
                    $(".respVarType").first().val(data.data[i].varType);
                    $(".respDescription").first().val(data.data[i].description);
                } else {
                    $("#setRespTable").append(addRespTpl(data.data[i].field, data.data[i].varType, "", data.data[i].description));
                }
            }

        })

    }

    function goToReqInfo() {
        const url = "/tool/goStructToField"
        var param = {
            "text": $("#bodyGo textarea").val(),
        }
        AjaxPost(url, param, function (data){

            delReqTpl();

            for(var i=0; i<data.data.length; i++) {

                var reqField = $('.reqField').map(function() {
                    return $(this).val();
                }).get();

                if (reqField[0] === "") {
                    $(".reqField").first().val(data.data[i].field);
                    $(".reqVarType").first().val(data.data[i].varType);
                    $(".reqDescription").first().val(data.data[i].description);
                } else {
                    $("#setReqTable").append(addReqTpl(data.data[i].field, data.data[i].varType, "", data.data[i].description, "1"));
                }
            }

        })
    }

    function clearDocEditor(opType) {

        $("#apiDocAddModalLabel").empty();
        if(opType === 2) {
            $("#apiDocAddModalLabel").append("编辑接口文档");
            $("#saveAdd").hide();
            $("#saveModify").show();
        } else {
            $("#apiDocAddModalLabel").append("新建接口文档");
            $("#saveAdd").show();
            $("#saveModify").hide();
        }

        $("#operateDocId").val("")
        var addDocName = $("#addDocName");
        var addDocUrl = $("#addDocUrl");
        var addDocMethod = $("#addDocMethod");
        var addDocDir = $("#addDocDir");
        var setHeaderTable = $("#setHeaderTable");
        var setReqTable = $("#setReqTable");
        var setRespTable = $("#setRespTable");

        addDocName.val("");
        addDocUrl.val("");

        var addDocMethodOption = $('#addDocMethod option').map(function(){
            return $(this).val();
        }).get();
        if (addDocMethodOption.length > 0 ) {
            addDocMethod.val(addDocMethodOption[0]);
        }

        var addDocDirOption = $('#addDocDir option').map(function(){
            return $(this).val();
        }).get();
        if (addDocDirOption.length > 0 ) {
            addDocDir.val(addDocDirOption[0]);
        }

        setHeaderTable.empty()
        setHeaderTable.append(initHeaderAdd())

        editorAdd.set({})

        $("#bodyXml textarea").val()
        $("#bodyText textarea").val()

        setReqTable.empty()
        setReqTable.append(initAddReqTpl())

        editorAddResp.set({})

        $("#respXml textarea").val()
        $("#respText textarea").val()

        setRespTable.empty()
        setRespTable.append(initAddRespTpl())

        editormdObj.clear();

    }

    function modifyDoc(docId) {
        console.log(docId)
        $("#addDocDir").val(docId)

        // 获取文档
        var param = {
            "pid": projectId,
            "docId": docId,
        }
        AjaxPostNotAsync("/document/item", param, function(data){
            if (data.code === 0 ) {

                clearDocEditor(2)

                console.log(data.data.content)
                $("#operateDocId").val(data.data.content.docId)

                var addDocName = $("#addDocName");
                var addDocUrl = $("#addDocUrl");
                var addDocMethod = $("#addDocMethod");
                var addDocDir = $("#addDocDir");
                var addDocHeaderField = $('.addDocHeaderField');
                var addDocHeaderIsRequired = $('.addDocHeaderIsRequired');
                var addDocHeaderVarType = $('.addDocHeaderVarType');
                var addDocHeaderDescription = $('.addDocHeaderDescription');
                var addDocHeaderExample = $('.addDocHeaderExample');
                var reqField = $('.reqField');
                var reqDescription = $('.reqDescription');
                var reqVarType = $('.reqVarType');
                var reqExample = $('.reqExample');
                var reqIsRequired = $('.reqIsRequired');
                var respField = $('.respField');
                var respDescription = $('.respDescription');
                var respVarType = $('.respVarType');
                var respExample = $('.respExample');

                addDocName.val(data.data.content.name);
                addDocUrl.val(data.data.content.url);
                addDocMethod.val(data.data.content.method);
                addDocDir.val(data.data.baseInfo.dirId);

                editormdObj.appendMarkdown(data.data.content.description);

                var reqHeader = data.data.content.reqHeader;
                for( var i=0; i<reqHeader.length; i++ ){
                    if (i===0) {
                        addDocHeaderField.first().val(reqHeader[0].field);
                        addDocHeaderIsRequired.first().val(reqHeader[0].isRequired);
                        addDocHeaderVarType.first().val(reqHeader[0].varType);
                        addDocHeaderDescription.first().val(reqHeader[0].description);
                        addDocHeaderExample.first().val(reqHeader[0].example);
                    } else {
                        $("#setHeaderTable").append(headerAddTpl(reqHeader[i].field, reqHeader[i].isRequired, reqHeader[i].varType,
                            reqHeader[0].description, reqHeader[0].example))
                    }
                }

                switch (data.data.content.reqType) {
                    case "json":
                        editorAdd.set(JSON.parse(data.data.content.reqBodyJson))
                        break
                    case "xml":
                        $("#bodyXml textarea").val(data.data.content.reqBodyXml)
                        break
                    case "plain":
                        $("#bodyText textarea").val(data.data.content.reqBodyText)
                }

                var reqBodyInfo = data.data.content.reqBodyInfo;
                for (var i=0; i<reqBodyInfo.length; i++) {
                    if (i===0) {
                        reqField.first().val(reqBodyInfo[0].field);
                        reqDescription.first().val(reqBodyInfo[0].description);
                        reqVarType.first().val(reqBodyInfo[0].varType);
                        reqExample.first().val(reqBodyInfo[0].example);
                        reqIsRequired.first().val(reqBodyInfo[0].isRequired);
                    } else {
                        $("#setReqTable").append(addReqTpl(reqBodyInfo[i].field, reqBodyInfo[i].varType, reqBodyInfo[i].example,
                            reqBodyInfo[i].description, reqBodyInfo[i].isRequired));
                    }
                }

                var respList = data.data.content.resp;
                if (respList.length > 0 ) {
                    var resp =  respList[0]
                    switch (resp.reqType) {
                        case "json":
                            editorAddResp.set(JSON.parse(resp.respBody));
                            break
                        case "xml":
                            $("#respXml textarea").val(resp.respBody);
                            break
                        case "plain":
                            $("#respText textarea").val(resp.respBody);
                            break
                    }

                    var respBody = resp.respBodyInfo;
                    for (var i=0; i<respBody.length; i++) {
                        if (i===0) {
                            respField.first().val(respBody[0].field);
                            respDescription.first().val(respBody[0].description);
                            respVarType.first().val(respBody[0].varType);
                            respExample.first().val(respBody[0].example);
                        }else {
                            $("#setRespTable").append(addRespTpl(respBody[i].field, respBody[i].varType, respBody[i].example,
                                respBody[i].description))
                        }
                    }
                }

                $('#apiDocAddModal').modal('show');
            }
        })

    }

    function modifyDocContent() {
        var docId = $("#docIdContent").text();
        modifyDoc(docId)
    }


    $(document).on('click', '.editDocButton', function (event){
        event.stopPropagation();
        var docId = $(this).parents("li").attr("id");
        modifyDoc(docId)
    })

    function openSnapshot(snapshotDocId, snapshotId) {
        var param = {
            "docId": snapshotDocId,
            "snapshotId": snapshotId,
        }
        AjaxPostNotAsync("/document/snapshot/item", param, function(data){
            if (data.code === 0 ) {
                console.log(data.data)

                $("#docNavSnapshot").empty();
                $("#docNavSnapshot").append("镜像:"+data.data.snapshotId);
                $("#docNav").show();

                loadApiDoc(data.data.documentContent, null)

                $("#docMain").animate({scrollTop:0}, 500)

            }
        })
    }

    function openGlobalCodeModal() {
        AjaxGetNotAsync("/project/code/list?pid="+projectId, function (data){
            console.log(data)
            if (data.code === 0) {
                $("#globalCodeTable").empty();
                $('#globalCodeTable').append(initGlobalCodeTpl());

                for(var i=0; i<data.data.length; i++) {
                    if (i===0) {
                        $(".globalCodeKey").first().val(data.data[0].field);
                        $(".globalCodeDescription").first().val(data.data[0].description);
                    } else {
                        $("#globalCodeTable").append(addGlobalCodeTpl(data.data[i].field, data.data[i].description));
                    }
                }

                $('#globalCodeModal').modal('show');
            }else {
                ToastShow(data.msg);
            }

        });

    }

    function openGlobalHeaderModal() {
        AjaxGetNotAsync("/project/header/list?pid="+projectId, function (data){
            console.log(data)
            if (data.code === 0) {
                $("#globalHeaderTable").empty();
                $('#globalHeaderTable').append(initGlobalHeaderAddTpl());

                for(var i=0; i<data.data.length; i++) {
                    if (i===0) {
                        $(".globalHeaderIsRequired").first().val(data.data[0].isRequired);
                        $(".globalHeaderField").first().val(data.data[0].field);
                        $(".globalHeaderDescription").first().val(data.data[0].description);
                        $(".globalHeaderVarType").first().val(data.data[0].varType);
                        $(".globalHeaderExample").first().val(data.data[0].example);
                    } else {
                        $("#globalHeaderTable").append(addGlobalHeaderAddTpl(data.data[i].isRequired, data.data[i].field, data.data[i].description,
                            data.data[i].varType, data.data[i].example));
                    }
                }

                $('#globalHeaderModal').modal('show');
            } else {
                ToastShow(data.msg);
            }
        })

    }

    $(document).on('click', '.globalCodeAdd', function (){
        $("#globalCodeTable").append(addGlobalCodeTpl("", ""))
    });

    $(document).on('click', '.globalCodeRemove', function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#globalCodeTable tr:eq('+index+')').remove();
    })

    $(document).on('click', '.globalHeaderAdd', function (){
        $("#globalHeaderTable").append(addGlobalHeaderAddTpl("", "", "", "", ""))
    });

    $(document).on('click', '.globalHeaderRemove',  function(event) {
        var target = event.target;
        var index = $(target).parents("tr").index();
        $('#globalHeaderTable tr:eq('+index+')').remove();
    })

    function globalCodeSubmit() {

        var globalCodeKey = $('.globalCodeKey').map(function() {
            return $(this).val();
        }).get();
        var globalCodeDescription = $('.globalCodeDescription').map(function() {
            return $(this).val();
        }).get();

        var list = []

        for (var i=0; i<globalCodeKey.length; i++) {
            list.push({
                "field":  globalCodeKey[i],     // 字段
                "description": globalCodeDescription[i], // 描述
            })
        }

        var param = {
            "projectId": projectId,
            "list": list,
        }

        AjaxPost("/project/code/add", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0 ) {
                console.log(data.data)
                $('#globalCodeModal').modal('hide');
            }
        });

    }

    function globalHeaderSubmit() {
        var globalHeaderIsRequired = $('.globalHeaderIsRequired').map(function() {
            return $(this).val();
        }).get();
        var globalHeaderField = $('.globalHeaderField').map(function() {
            return $(this).val();
        }).get();
        var globalHeaderDescription = $('.globalHeaderDescription').map(function() {
            return $(this).val();
        }).get();
        var globalHeaderVarType = $('.globalHeaderVarType').map(function() {
            return $(this).val();
        }).get();
        var globalHeaderExample = $('.globalHeaderExample').map(function() {
            return $(this).val();
        }).get();

        var list = []

        for (var i=0; i<globalHeaderField.length; i++) {
            list.push({
                "field" : globalHeaderField[i],
                "varType" : globalHeaderVarType[i],
                "description" : globalHeaderDescription[i],
                "example" : globalHeaderExample[i],
                "isRequired" : Number(globalHeaderIsRequired[i]),
            })
        }

        var param = {
            "projectId" : projectId,
            "reqHeader" : list,
        }

        AjaxPost("/project/header/add", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0 ) {
                console.log(data.data)
                $('#globalHeaderModal').modal('hide');
            }
        });

    }

    $(document).on('click', '.docShare', function (event){
        event.stopPropagation();
        var docId = $(this).data("docid");
        openShare(2, docId)
    });

    function openDocShare() {
        console.log("openDocShare")
        var docId = localStorage.getItem(nowViewDoc+projectId)
        console.log(docId)
        if(docId !== "undefined") {
            openShare(2, docId)
        }
    }

    function openShare(sType, docId) {

        var shareModalLabel = $("#shareModalLabel")
        shareModalLabel.empty()

        var projectShareBtn = $("#projectShareBtn")
        var docShareBtn = $("#docShareBtn")

        projectShareBtn.hide()
        docShareBtn.hide()

        switch (sType) {
            case 1:
                shareModalLabel.append("分享项目")
                projectShareBtn.show()
                break
            case 2:
                shareModalLabel.append("分享文档")
                $("#shareDocId").val(docId)
                docShareBtn.show()
                break
        }

        shareListLoad(sType, docId)

        $('#shareModal').modal('show');
    }

    function shareListLoad(sType, docId) {

        switch (sType) {
            case 1:
                AjaxGetNotAsync("/share/info/project?pid="+projectId, function (data) {
                    console.log(data)
                    if (data.code === 0) {
                        shareListShow(data.data)
                    }
                })
                break
            case 2:
                AjaxGetNotAsync("/share/info/document?docId="+docId, function (data) {
                    console.log(data)
                    if (data.code === 0) {
                        shareListShow(data.data)
                    }
                })
                break
        }
    }

    function shareListShow(data) {
        var shareList = $('#shareList')
        shareList.empty()
        const currentHost = window.location.host + "/browse/";
        for (var i=0; i<data.length; i++ ) {

            var expiration = ""
            if (data[i].expiration === 0 ) {
                expiration = "过期"
            }else if (data[i].expiration === -1 ) {
                expiration = "永久"
            }else {
                expiration = data[i].expiration+"天"
            }

            var password = ""
            if (data[i].isPassword === 1) {
                password = '<span class="badge text-bg-info">密码: '+data[i].passwordCode+'</span>'
            }else {
                password =  '<span class="badge text-bg-info">公开</span>'
            }

            shareList.append('<div class="list-group-item list-group-item-action">\n' +
                '                        <span style="margin-right: 16px;">'+currentHost+data[i].key+'</span> '+
                '<span class="badge text-bg-dark" style="margin-right: 8px;">'+expiration+'</span>'+ password +
                '                        <button type="button" class="btn btn-link" style="float: right;" onclick="cpShare(\''+currentHost+data[i].key+'\')">复制</button>\n' +
                '                        <button type="button" class="btn btn-link" style="float: right; color: red" onclick="delShare(\''+data[i].key+'\')">删除</button>\n' +
                '                    </div>')
        }
    }

    $('#shareExpiration').mousemove(function(){
        var num = $("#shareExpiration").val()
        var customRange2 = $("#shareExpiration2")
        customRange2.empty()
        if (num === "0") {
            customRange2.append("永久")
        } else {
            customRange2.append(num+"天")
        }
    });

    $('#shareIsPassword').change(function() {
        var shareIsPassword2 = $('#shareIsPassword2')
        shareIsPassword2.empty()
        if(this.checked) {
            var num = getRandomInt(100000, 999999)
            shareIsPassword2.append(num)
        }
    });

    // 生成一个0到1之间的随机小数
    var randomNum = Math.random();

    // 生成一个范围在[min, max]之间的随机整数
    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    $('#addShareExpiration').click(function (){
        console.log("addShareExpiration")
        var shareExpiration = $("#shareExpiration")
        var num = shareExpiration.val()
        num = Number(num)
        if (num < 365) {
            num = num+1
        }
        shareExpiration.val(num)
        var customRange2 = $("#shareExpiration2")
        customRange2.empty()
        if (num === "0" || num === 0) {
            customRange2.append("永久")
        } else {
            customRange2.append(num+"天")
        }
    })

    $('#cutShareExpiration').click(function (){
        var shareExpiration = $("#shareExpiration")
        var num = shareExpiration.val()
        num = Number(num)
        if (num > 0) {
            num = num-1
        }
        shareExpiration.val(num)
        var customRange2 = $("#shareExpiration2")
        customRange2.empty()
        if (num === "0" || num === 0) {
            customRange2.append("永久")
        } else {
            customRange2.append(num+"天")
        }
    })

    function projectShare() {
        createShare(1, projectId)
    }

    function docShare() {
        var docId = $("#shareDocId").val()
        createShare(2, docId)
    }

    function createShare(shareType, shareId) {

        var isPassword = 0;
        var passwordCode = $("#shareIsPassword2").text();
        if (passwordCode !== "") {
            isPassword = 1
        }

        var param = {
            "shareType": shareType,
            "shareId": shareId,
            "expiration": Number($("#shareExpiration").val()),
            "isPassword": isPassword,
            "passwordCode": passwordCode,
        }

        AjaxPost("/share/create", param, function (data) {
            ToastShow(data.msg);
            if (data.code === 0 ) {
                shareListLoad(shareType, shareId)
                $("#shareExpiration").val(0);
                $("#shareIsPassword").prop('checked', false);
                $("#shareExpiration2").empty();
                $("#shareExpiration2").append("永久");
                $("#shareIsPassword2").empty();
            }
        });
    }

    function delShare(key) {
        AjaxGetNotAsync("/share/del?key="+key, function (data) {
            console.log(data)
            if (data.code === 0) {
                shareListLoad(data.data.shareType, data.data.shareId)
            }
        })
    }

    function cpShare(url) {
        copyContent(url)
        ToastShow("已复制到剪切板");
    }

</script>
{{ template "end" . }}